---
phase: 21-bsl-recording
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - entrypoints/background/llm/promptBuilder.ts
  - entrypoints/background/llm/fallback.ts
autonomous: true

must_haves:
  truths:
    - "LLM BSL prompt teaches the model to use fieldset_context, associated_label, and section_context hints for form section disambiguation"
    - "LLM BSL prompt includes an example showing two inputs in different fieldsets producing distinct hint sets"
    - "Fallback BSL generator includes fieldset_context, associated_label, and section_context in filterHints priority ranking"
    - "Fallback BSL generator preserves fieldset_context hints (not filtered out) when generating BSL for form inputs"
    - "Two identical inputs in different form sections produce distinct BSL steps in both LLM and fallback output"
  artifacts:
    - path: "entrypoints/background/llm/promptBuilder.ts"
      provides: "Structural hint guidance in LLM BSL generation prompt"
      contains: "fieldset_context"
    - path: "entrypoints/background/llm/fallback.ts"
      provides: "Structural hint types in filterHints priority"
      contains: "fieldset_context"
  key_links:
    - from: "entrypoints/background/llm/promptBuilder.ts"
      to: "entrypoints/content/recording/types.ts"
      via: "references HintType values in prompt text"
      pattern: "fieldset_context.*associated_label.*section_context"
    - from: "entrypoints/background/llm/fallback.ts"
      to: "entrypoints/content/recording/types.ts"
      via: "imports SemanticHint, uses HintType values in priority map"
      pattern: "fieldset_context.*section_context"
---

<objective>
Update the BSL generation prompt (LLM path) and fallback generator (no-LLM path) to understand and preserve the new structural context hint types (fieldset_context, associated_label, section_context) so that generated BSL scripts include form section disambiguation.

Purpose: Plan 21-01 captures structural context at recording time. This plan ensures that context flows through to the generated BSL -- both when an LLM processes the hints and when the deterministic fallback generator builds BSL directly. Without this, the new hints would be recorded but silently dropped or ignored during BSL generation.

Output: Updated promptBuilder.ts with structural hint guidance and examples, updated fallback.ts with structural hints in filterHints priority ranking.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@entrypoints/background/llm/promptBuilder.ts
@entrypoints/background/llm/fallback.ts
@entrypoints/content/recording/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structural hint types to promptBuilder BSL generation prompts</name>
  <files>entrypoints/background/llm/promptBuilder.ts</files>
  <action>
Update both `buildBSLPrompt()` and `buildCompactBSLPrompt()` to teach the LLM about structural context hints.

**In `buildBSLPrompt()` -- update the Hint Types section:**

Add 3 new hint types to the ordered list (after near_label, before class_contains). Insert them between items 8 and 9 in the current list:

```
8. **near_label** - Associated label text - Proximity-based, context-dependent
9. **fieldset_context** - Fieldset legend text (e.g., "Billing Address", "Shipping Address") - Critical for disambiguating identical inputs in different form sections
10. **associated_label** - Label text via for=/aria-labelledby - More precise than near_label when explicit label association exists
11. **section_context** - Nearest section heading text (h1-h6) - Helps identify which page section the element belongs to
12. **class_contains** - Semantic CSS classes (NOT utility classes like Tailwind) - Less stable
13. **id** - Element ID - ONLY if not auto-generated (avoid UUIDs, React/Vue prefixes)
```

Also update the hints array in the BSL format YAML block to include the 3 new types:
```yaml
hints:
  - type: data_attribute|role|type|aria_label|name|text_contains|placeholder_contains|near_label|fieldset_context|associated_label|section_context|class_contains|id
```

**Add a new "Structural Context" rules section** after the existing "Styled Links vs Real Buttons" section (before ## Rules):

```
## IMPORTANT: Structural Context Hints (Form Disambiguation)
When actions include `fieldset_context`, `associated_label`, or `section_context` hints, these provide critical structural DOM context:

- **fieldset_context**: The fieldset legend text. When two inputs have identical name/type/role but different fieldset_context values (e.g., "Billing Address" vs "Shipping Address"), the fieldset_context is what distinguishes them. ALWAYS include fieldset_context in the generated hints when present.
- **associated_label**: Explicit label association (via for= or aria-labelledby). More precise than near_label. Prefer this over near_label when both exist for the same element.
- **section_context**: Section heading text (h1-h6). Useful when elements are in different page sections but not in fieldsets.

Example - two "Email" inputs in a checkout form:
```yaml
# Billing email
- action: type
  target:
    hints:
      - type: role
        value: textbox
      - type: name
        value: email
      - type: fieldset_context
        value: "Billing Address"
  value: "user@example.com"

# Shipping email
- action: type
  target:
    hints:
      - type: role
        value: textbox
      - type: name
        value: email
      - type: fieldset_context
        value: "Shipping Address"
  value: "user@example.com"
```
Without fieldset_context, these two steps would be indistinguishable.
```

**Add a new rule** (append to existing rules list):

```
15. **STRUCTURAL HINTS**: When captured actions include `fieldset_context`, `associated_label`, or `section_context` hints, ALWAYS preserve them in the generated BSL. These hints are critical for disambiguating identical elements in different form sections. Without them, the resolver cannot distinguish between e.g., "Email" in billing vs "Email" in shipping.
```

**In `buildCompactBSLPrompt()` -- update the hints line:**

Update the hint priority list to include the new types:
```
Hints (by priority): data_attribute, role, type, aria_label, name, text_contains, placeholder_contains, near_label, fieldset_context, associated_label, section_context, class_contains, id
```

Add a compact structural hints rule:
```
- STRUCTURAL HINTS: fieldset_context (fieldset legend), associated_label (label[for]/aria-labelledby), section_context (heading) disambiguate identical elements in different form sections. ALWAYS preserve these when present.
```
  </action>
  <verify>
1. Run `npx tsc --noEmit entrypoints/background/llm/promptBuilder.ts` -- zero errors.
2. Grep for `fieldset_context` in promptBuilder.ts -- at least 3 matches (hint list, example, rule).
3. Grep for `associated_label` in promptBuilder.ts -- at least 2 matches.
4. Grep for `section_context` in promptBuilder.ts -- at least 2 matches.
  </verify>
  <done>Both buildBSLPrompt and buildCompactBSLPrompt include structural hint type documentation, a disambiguation example (billing vs shipping email), and a rule requiring preservation of structural hints. LLM will generate BSL that includes fieldset_context/associated_label/section_context when present in captured actions.</done>
</task>

<task type="auto">
  <name>Task 2: Add structural hint types to fallback BSL generator filterHints</name>
  <files>entrypoints/background/llm/fallback.ts</files>
  <action>
Update the `filterHints()` function to include the 3 new structural hint types in the priority ranking.

**Update the priority map** to include fieldset_context, associated_label, and section_context. These should be ranked HIGH because they are critical for disambiguation -- higher than near_label but lower than name/type/role:

```typescript
const priority: Record<string, number> = {
  'name': 1,
  'type': 2,
  'id': 3,
  'role': 4,
  'placeholder_contains': 5,
  'text_contains': 6,
  'aria_label': 7,
  'fieldset_context': 8,     // NEW: critical for form section disambiguation
  'associated_label': 9,     // NEW: explicit label association
  'section_context': 10,     // NEW: page section context
  'near_label': 11,          // Moved down -- less precise than associated_label
  'data_attribute': 12,
  'class_contains': 13,
};
```

**Increase the max hints from 4 to 5** when structural hints are present. The current logic takes "up to 4 hints" which could filter out the new structural context hints that are essential for disambiguation:

Replace the fixed `result.length >= 4` check with a dynamic limit:

```typescript
// Take up to 4 hints normally, but allow 5 if structural hints are present
// (fieldset_context/section_context are essential for disambiguation)
const hasStructuralHints = sorted.some(h =>
  h.type === 'fieldset_context' || h.type === 'section_context'
);
const maxHints = hasStructuralHints ? 5 : 4;

const result: SemanticHint[] = [];
for (const hint of sorted) {
  if (result.length >= maxHints) break;

  // Skip class_contains if we already have 2+ good hints
  if (hint.type === 'class_contains' && result.length >= 2) continue;

  result.push(hint);
}
```

This ensures that when an element has fieldset_context (e.g., "Billing Address"), it will NOT be pushed out by 4 higher-priority hints. The structural context is what makes two otherwise-identical inputs distinguishable.

Do NOT change any other function in fallback.ts -- only filterHints.
  </action>
  <verify>
1. Run `npx tsc --noEmit entrypoints/background/llm/fallback.ts` -- zero errors.
2. Run `npx tsc --noEmit` (full project) -- zero errors.
3. Grep for `fieldset_context` in fallback.ts -- at least 2 matches (priority map + structural check).
4. Grep for `maxHints` in fallback.ts -- confirms dynamic hint limit.
  </verify>
  <done>filterHints() now includes fieldset_context (priority 8), associated_label (priority 9), and section_context (priority 10) in its ranking. When structural hints are present, up to 5 hints are preserved (instead of 4) to ensure disambiguation context is not filtered out. Two identical inputs in different fieldsets will produce distinct BSL steps in fallback-generated scripts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles with zero errors
2. `npm run build` -- extension builds successfully
3. promptBuilder.ts mentions all 3 new hint types in both buildBSLPrompt and buildCompactBSLPrompt
4. fallback.ts filterHints priority map includes all 3 new hint types
5. fallback.ts uses dynamic maxHints (5 when structural hints present, 4 otherwise)
</verification>

<success_criteria>
- LLM BSL prompt documents fieldset_context, associated_label, section_context with disambiguation example
- LLM BSL prompt has a rule requiring preservation of structural hints
- Compact prompt also updated with new hint types
- Fallback filterHints includes all 3 new types in priority ranking
- Fallback allows 5 hints when structural context is present (prevents disambiguation loss)
- TypeScript compiles with zero errors
- Requirements BSLG-03, BSLG-04, BSLG-05 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/21/21-02-SUMMARY.md`
</output>
