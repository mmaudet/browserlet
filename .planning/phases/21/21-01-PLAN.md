---
phase: 21-bsl-recording
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - entrypoints/content/recording/types.ts
  - entrypoints/content/recording/hintGenerator.ts
autonomous: true

must_haves:
  truths:
    - "Recording an input inside a fieldset captures the fieldset legend text as a fieldset_context hint"
    - "Recording an input with a label[for=] or aria-labelledby captures the label text as an associated_label hint (distinct from near_label)"
    - "Recording two identical inputs in different fieldsets (billing Email vs shipping Email) produces different hint sets"
    - "Recording an input near a section heading captures the heading as a section_context hint"
    - "Existing hint generation still works for elements with no structural context (no regressions)"
  artifacts:
    - path: "entrypoints/content/recording/types.ts"
      provides: "Extended HintType union with fieldset_context, associated_label, section_context"
      contains: "fieldset_context"
    - path: "entrypoints/content/recording/hintGenerator.ts"
      provides: "Structural context hints via DOMContextExtractor"
      contains: "extractDOMContext"
  key_links:
    - from: "entrypoints/content/recording/hintGenerator.ts"
      to: "entrypoints/content/playback/domContextExtractor.ts"
      via: "import { extractDOMContext }"
      pattern: "import.*extractDOMContext.*domContextExtractor"
    - from: "entrypoints/content/recording/hintGenerator.ts"
      to: "entrypoints/content/recording/types.ts"
      via: "uses extended HintType"
      pattern: "fieldset_context|associated_label|section_context"
---

<objective>
Add structural DOM context capture to the recording hint generator so that recorded actions include fieldset, label, and section heading context as semantic hints.

Purpose: When users record interactions with forms that have fieldsets (billing/shipping), labeled inputs, or section headings, the generated hints will be richer and more distinguishable. This directly feeds the enriched cascade resolver from Phase 19 and produces higher-quality BSL from day one.

Output: Updated hintGenerator.ts that imports DOMContextExtractor and generates 3 new hint types (fieldset_context, associated_label, section_context), plus updated types.ts with extended HintType union.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@entrypoints/content/recording/types.ts
@entrypoints/content/recording/hintGenerator.ts
@entrypoints/content/playback/domContextExtractor.ts
@utils/hints/dom.ts
@utils/hints/text.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend HintType union with structural context types</name>
  <files>entrypoints/content/recording/types.ts</files>
  <action>
Add 3 new hint types to the HintType union in types.ts:

1. `'fieldset_context'` -- captures the fieldset legend text when an element is inside a fieldset. This is distinct from `near_label` because it specifically identifies the form section (e.g., "Billing Address", "Shipping Address").

2. `'associated_label'` -- captures the label text resolved via `aria-labelledby` or `label[for=]`. This is distinct from the existing `near_label` hint because it uses explicit HTML label association rather than proximity. The existing `near_label` hint (slot 8) uses `findAssociatedLabel()` from dom.ts which DOES handle `label[for=]` and parent labels but NOT `aria-labelledby`. The new `associated_label` hint will use DOMContextExtractor's `extractAssociatedLabel()` which handles ALL three methods (aria-labelledby, label[for=], parent label).

3. `'section_context'` -- captures the nearest section heading (h1-h6) text. Helps distinguish elements under different page sections.

Update the HintType union:
```typescript
export type HintType =
  | 'role'
  | 'text_contains'
  | 'type'
  | 'name'
  | 'placeholder_contains'
  | 'aria_label'
  | 'near_label'
  | 'class_contains'
  | 'data_attribute'
  | 'id'
  | 'fieldset_context'
  | 'associated_label'
  | 'section_context';
```

Do NOT change the SemanticHint interface or CapturedAction interface -- the new hint types use the same `{ type, value: string }` shape.
  </action>
  <verify>Run `npx tsc --noEmit entrypoints/content/recording/types.ts` -- zero errors. Grep for `fieldset_context` in types.ts to confirm presence.</verify>
  <done>HintType union includes fieldset_context, associated_label, and section_context. All existing types preserved. No interface changes needed.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate DOMContextExtractor into hintGenerator for structural context hints</name>
  <files>entrypoints/content/recording/hintGenerator.ts</files>
  <action>
Import `extractDOMContext` from the DOMContextExtractor (playback directory -- it's pure DOM traversal, no playback dependencies):

```typescript
import { extractDOMContext } from '../playback/domContextExtractor';
```

Add structural context hints at the END of the `generateHints()` function, after the existing 10 hint types (before `return hints`). This preserves all existing behavior and adds new structural context on top.

Add these 3 structural hint extractions:

**11. Fieldset context (BSLG-01):**
```typescript
// 11. Fieldset context -- captures fieldset legend for form section disambiguation
const domContext = extractDOMContext(element);
if (domContext.fieldset_legend) {
  hints.push({ type: 'fieldset_context', value: domContext.fieldset_legend });
}
```

**12. Associated label via DOMContextExtractor (BSLG-02):**
```typescript
// 12. Associated label (aria-labelledby, label[for], parent label)
// Uses DOMContextExtractor which handles aria-labelledby (existing near_label from dom.ts does not)
// Only add if different from existing near_label hint to avoid redundancy
if (domContext.associated_label) {
  const existingNearLabel = hints.find(h => h.type === 'near_label');
  const alreadyCaptured = existingNearLabel &&
    typeof existingNearLabel.value === 'string' &&
    existingNearLabel.value === domContext.associated_label;
  if (!alreadyCaptured) {
    hints.push({ type: 'associated_label', value: domContext.associated_label });
  }
}
```

**13. Section context (heading) -- aids disambiguation for elements under different page sections:**
```typescript
// 13. Section context -- nearest heading for section disambiguation
if (domContext.section_heading) {
  hints.push({ type: 'section_context', value: domContext.section_heading });
}
```

Important implementation notes:
- Call `extractDOMContext(element)` ONCE and reuse the result for all 3 hints (avoid redundant DOM traversals).
- The DOMContextExtractor also provides `near_label` with distance, but we do NOT replace the existing near_label hint (slot 8) because that would change existing behavior. The existing `findAssociatedLabel()` from dom.ts is what currently generates near_label and it works fine. We ADD the new associated_label hint for aria-labelledby coverage.
- The DOMContextExtractor provides `landmark` and `sibling_texts` too, but we do NOT capture those as recording hints. They are used at playback time by StructuralScorer for resolution. Recording only needs the hints that will appear in BSL.
- Performance: extractDOMContext is synchronous, bounded O(depth), and adds negligible overhead to the <50ms hint generation target.
  </action>
  <verify>
1. Run `npx tsc --noEmit entrypoints/content/recording/hintGenerator.ts` -- zero errors.
2. Run `npx tsc --noEmit` (full project) -- zero errors.
3. Grep for `extractDOMContext` in hintGenerator.ts to confirm import and usage.
4. Grep for `fieldset_context` in hintGenerator.ts to confirm hint generation.
  </verify>
  <done>
generateHints() now produces up to 13 hint types. Elements inside fieldsets get a `fieldset_context` hint with the legend text. Elements with aria-labelledby or label[for=] get an `associated_label` hint (if not redundant with near_label). Elements under section headings get a `section_context` hint. Two identical inputs in different fieldsets (billing Email vs shipping Email) now produce distinguishable hint sets because they have different `fieldset_context` values.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles with zero errors
2. `npm run build` -- extension builds successfully (both Chrome and Firefox if configured)
3. Grep confirms new hint types exist in types.ts: `grep -c 'fieldset_context\|associated_label\|section_context' entrypoints/content/recording/types.ts` returns 3
4. Grep confirms DOMContextExtractor import in hintGenerator.ts: `grep 'extractDOMContext' entrypoints/content/recording/hintGenerator.ts`
</verification>

<success_criteria>
- HintType union extended with fieldset_context, associated_label, section_context
- hintGenerator.ts imports and uses extractDOMContext from DOMContextExtractor
- Structural hints generated when DOM context is available (fieldset, label, heading)
- No regression: existing 10 hint types still generated identically
- TypeScript compiles with zero errors
- Requirements BSLG-01, BSLG-02 addressed at recording level
</success_criteria>

<output>
After completion, create `.planning/phases/21/21-01-SUMMARY.md`
</output>
