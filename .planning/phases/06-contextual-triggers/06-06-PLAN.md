---
phase: 06-contextual-triggers
plan: 06
type: execute
wave: 5
depends_on: ["06-05"]
files_modified:
  - entrypoints/sidepanel/main.ts
  - entrypoints/sidepanel/router.ts
  - entrypoints/sidepanel/components/ScriptList.ts
autonomous: false

must_haves:
  truths:
    - "SuggestedScripts component appears at top of sidepanel when context matches"
    - "Trigger configuration accessible from script list or editor"
    - "Running a suggested script navigates to execution view"
    - "Badge shows number of suggested scripts on extension icon"
    - "User can test trigger configuration and see it work"
  artifacts:
    - path: "entrypoints/sidepanel/main.ts"
      provides: "Main sidepanel entry with SuggestedScripts integration"
    - path: "entrypoints/sidepanel/components/ScriptList.ts"
      provides: "Script list with trigger config button"
  key_links:
    - from: "entrypoints/sidepanel/main.ts"
      to: "entrypoints/sidepanel/components/SuggestedScripts.ts"
      via: "import and render"
      pattern: "import.*SuggestedScripts"
    - from: "entrypoints/sidepanel/components/ScriptList.ts"
      to: "entrypoints/sidepanel/components/TriggerConfig.ts"
      via: "import and render on demand"
      pattern: "import.*TriggerConfig"
---

<objective>
Integrate trigger UI components into Side Panel and verify end-to-end functionality.

Purpose: Complete the user experience by wiring trigger configuration and suggestions into the existing Side Panel, then verify the full trigger flow works correctly.

Output: Integrated Side Panel with suggestions, trigger config access, and verified E2E trigger functionality.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-contextual-triggers/06-RESEARCH.md

# Prior plan summaries
@.planning/phases/06-contextual-triggers/06-04-SUMMARY.md
@.planning/phases/06-contextual-triggers/06-05-SUMMARY.md

# Existing UI patterns
@entrypoints/sidepanel/main.ts
@entrypoints/sidepanel/router.ts
@entrypoints/sidepanel/components/ScriptList.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SuggestedScripts to main sidepanel</name>
  <files>entrypoints/sidepanel/main.ts</files>
  <action>
Update the main sidepanel entry to include SuggestedScripts at the top:

1. Import SuggestedScripts:
```typescript
import { SuggestedScripts } from './components/SuggestedScripts';
```

2. Import triggers store to check for suggestions:
```typescript
import { suggestedScriptIds, loadTriggers } from './stores/triggers';
```

3. Add SuggestedScripts component at the top of the main layout (before the router content):

In the main render function, add a conditional SuggestedScripts section:
```typescript
// After header, before main content:
() => suggestedScriptIds.val.length > 0
  ? div({ class: 'suggested-scripts-container px-4 py-3 bg-blue-50 border-b border-blue-100' },
      SuggestedScripts({
        onRunScript: (script) => {
          // Navigate to run view and start execution
          navigateTo('run');
          // Trigger execution
          chrome.tabs.query({ active: true, currentWindow: true }, async (tabs) => {
            if (tabs[0]?.id) {
              await chrome.tabs.sendMessage(tabs[0].id, {
                type: 'EXECUTE_SCRIPT',
                payload: { content: script.content }
              });
            }
          });
        }
      })
    )
  : null,
```

4. Initialize triggers store on load:
```typescript
// In the initialization section:
loadTriggers();
```

The SuggestedScripts section should:
- Appear at the top only when there are suggestions
- Have a distinct blue background to stand out
- Disappear when dismissed or when context changes
  </action>
  <verify>
Run `npm run build` - should build without errors.
Load extension and verify SuggestedScripts area appears when there are matching scripts.
  </verify>
  <done>
SuggestedScripts integrated into main sidepanel, appears when context matches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trigger configuration access to ScriptList</name>
  <files>entrypoints/sidepanel/components/ScriptList.ts</files>
  <action>
Update ScriptList to provide access to trigger configuration for each script:

1. Import TriggerConfig:
```typescript
import { TriggerConfig } from './TriggerConfig';
```

2. Add state for showing trigger config:
```typescript
const showTriggerConfig = van.state<string | null>(null);
```

3. Add a trigger icon button to each script item (in the action buttons area):
```typescript
button({
  class: 'p-1 text-gray-400 hover:text-gray-600',
  title: 'Configure triggers',
  onclick: (e: Event) => {
    e.stopPropagation();
    showTriggerConfig.val = script.id;
  }
}, '\u26A1') // Lightning bolt emoji as trigger icon
```

4. Render TriggerConfig modal when a script is selected:
```typescript
// At the end of the component, add:
() => showTriggerConfig.val
  ? div({
      class: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
      onclick: () => { showTriggerConfig.val = null; }
    },
      div({
        class: 'bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto',
        onclick: (e: Event) => e.stopPropagation()
      },
        TriggerConfig({
          scriptId: showTriggerConfig.val,
          onClose: () => { showTriggerConfig.val = null; }
        })
      )
    )
  : null
```

The trigger config should:
- Open as a modal overlay
- Close when clicking outside or the X button
- Save/delete triggers for the selected script
  </action>
  <verify>
Run `npm run build` - should build without errors.
Load extension and verify trigger config opens from script list.
  </verify>
  <done>
ScriptList includes trigger config button, modal overlay for configuration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: E2E Verification of Trigger System</name>
  <what-built>
Complete contextual trigger system with:
- URL pattern matching triggers
- Suggest mode (badge + sidepanel suggestions)
- Auto-execute mode (notification + automatic run)
- Per-script trigger configuration UI
- Context detection via MutationObserver
  </what-built>
  <how-to-verify>
**Setup:**
1. Load the extension in Chrome: `npm run dev` then chrome://extensions
2. Open the Side Panel

**Test 1: Suggest Mode Trigger**
1. Create a new script in the Side Panel (or use existing)
2. Click the lightning bolt icon to open Trigger Config
3. Add trigger with URL pattern: `*google.com*`
4. Set mode to "Suggest"
5. Save and close
6. Navigate to google.com in a new tab
7. Expected:
   - Extension icon shows badge with "1"
   - Side Panel shows suggested script at top with blue background
   - Click "Run" executes the script

**Test 2: Auto-Execute Mode Trigger**
1. Edit the trigger, change mode to "Auto-execute"
2. Set cooldown to 1 minute
3. Save and navigate to google.com again
4. Expected:
   - Chrome notification appears: "Script Auto-Executing: [script name]"
   - Script starts executing automatically
   - Notification has "Stop" and "Disable for this site" buttons

**Test 3: Site Override**
1. Click "Disable for this site" in the notification
2. Refresh google.com
3. Expected: Script does NOT auto-execute (disabled for google.com)

**Test 4: Performance Check**
1. Open DevTools Performance tab
2. Navigate to a page with active triggers
3. Expected: No visible performance degradation, no excessive "Recalculate Style" events

**Test 5: Multiple Triggers**
1. Add triggers to 2-3 different scripts with the same URL pattern
2. Navigate to matching page
3. Expected: Badge shows count, all scripts appear in suggestions
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. Extension builds and loads without errors
2. SuggestedScripts appears at top of sidepanel when context matches
3. Trigger config accessible from script list
4. Suggest mode shows badge and suggestions
5. Auto-execute mode shows notification and runs script
6. Site override disables triggers for specific domain
7. No visible performance impact from context monitoring
</verification>

<success_criteria>
- [ ] SuggestedScripts integrated into main.ts
- [ ] TriggerConfig accessible from ScriptList via modal
- [ ] Suggest mode: badge updates, scripts appear in suggestions
- [ ] Auto-execute mode: notification appears, script runs
- [ ] Site override works (disable for site)
- [ ] Performance acceptable (no lag on page navigation)
- [ ] E2E verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/06-contextual-triggers/06-06-SUMMARY.md`
</output>
