---
phase: 06-contextual-triggers
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - entrypoints/sidepanel/components/TriggerConfig.ts
  - entrypoints/sidepanel/components/SuggestedScripts.ts
  - public/_locales/en/messages.json
  - public/_locales/fr/messages.json
autonomous: true

must_haves:
  truths:
    - "User can configure trigger conditions (URL pattern, element hints) for a script"
    - "User can set trigger mode (suggest or auto-execute)"
    - "User can enable/disable triggers"
    - "Suggested scripts appear in Side Panel when context matches"
    - "User can run suggested script with one click"
  artifacts:
    - path: "entrypoints/sidepanel/components/TriggerConfig.ts"
      provides: "UI component for configuring trigger conditions and mode"
      exports: ["TriggerConfig"]
    - path: "entrypoints/sidepanel/components/SuggestedScripts.ts"
      provides: "UI component showing context-matched scripts"
      exports: ["SuggestedScripts"]
  key_links:
    - from: "entrypoints/sidepanel/components/TriggerConfig.ts"
      to: "chrome.runtime.sendMessage"
      via: "SAVE_TRIGGER message"
      pattern: "sendMessage.*SAVE_TRIGGER"
    - from: "entrypoints/sidepanel/components/SuggestedScripts.ts"
      to: "chrome.runtime.sendMessage"
      via: "GET_SUGGESTED_SCRIPTS message"
      pattern: "sendMessage.*GET_SUGGESTED_SCRIPTS"
---

<objective>
Create Side Panel UI components for trigger configuration and suggested scripts display.

Purpose: Enable users to configure trigger conditions per script and see context-matched script suggestions in the Side Panel.

Output: TriggerConfig component for editing triggers, SuggestedScripts component for displaying matches, i18n strings.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-contextual-triggers/06-RESEARCH.md

# Prior plan summaries
@.planning/phases/06-contextual-triggers/06-01-SUMMARY.md
@.planning/phases/06-contextual-triggers/06-04-SUMMARY.md

# Existing UI patterns
@entrypoints/sidepanel/components/ScriptList.ts
@entrypoints/sidepanel/components/LLMSettings.ts
@entrypoints/sidepanel/stores/scripts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add i18n strings for trigger UI</name>
  <files>
    public/_locales/en/messages.json
    public/_locales/fr/messages.json
  </files>
  <action>
Add i18n strings for trigger configuration and suggestions.

Add to en/messages.json:
```json
"triggerConfigTitle": {
  "message": "Trigger Configuration",
  "description": "Title for trigger configuration section"
},
"triggerUrlPattern": {
  "message": "URL Pattern",
  "description": "Label for URL pattern input"
},
"triggerUrlPatternPlaceholder": {
  "message": "*/dashboard*",
  "description": "Placeholder for URL pattern"
},
"triggerElementHints": {
  "message": "Element Hints (optional)",
  "description": "Label for element hints"
},
"triggerModeSuggest": {
  "message": "Suggest",
  "description": "Suggest mode option"
},
"triggerModeAutoExecute": {
  "message": "Auto-execute",
  "description": "Auto-execute mode option"
},
"triggerModeLabel": {
  "message": "When conditions match:",
  "description": "Label for trigger mode selection"
},
"triggerEnabled": {
  "message": "Enabled",
  "description": "Enabled checkbox label"
},
"triggerSave": {
  "message": "Save Trigger",
  "description": "Save trigger button"
},
"triggerDelete": {
  "message": "Delete",
  "description": "Delete trigger button"
},
"triggerAddCondition": {
  "message": "Add Condition",
  "description": "Add condition button"
},
"suggestedScriptsTitle": {
  "message": "Suggested Scripts",
  "description": "Title for suggested scripts section"
},
"suggestedScriptsEmpty": {
  "message": "No scripts match current context",
  "description": "Empty state for suggestions"
},
"suggestedScriptRun": {
  "message": "Run",
  "description": "Run suggested script button"
},
"notificationAutoExecuteTitle": {
  "message": "Script Auto-Executing",
  "description": "Notification title for auto-execute"
},
"notificationAutoExecuteMessage": {
  "message": "Running: $1",
  "description": "Notification message with script name"
},
"notificationStop": {
  "message": "Stop",
  "description": "Stop button in notification"
},
"notificationDisableSite": {
  "message": "Disable for this site",
  "description": "Disable for site button in notification"
},
"notificationCompleteTitle": {
  "message": "Script Completed",
  "description": "Completion notification title"
},
"notificationFailedTitle": {
  "message": "Script Failed",
  "description": "Failure notification title"
},
"triggerCooldown": {
  "message": "Cooldown (minutes)",
  "description": "Label for cooldown setting"
}
```

Add equivalent French translations to fr/messages.json:
```json
"triggerConfigTitle": {
  "message": "Configuration des triggers",
  "description": "Titre de la section de configuration des triggers"
},
"triggerUrlPattern": {
  "message": "Motif URL",
  "description": "Label pour le champ motif URL"
},
"triggerUrlPatternPlaceholder": {
  "message": "*/tableau-de-bord*",
  "description": "Placeholder pour le motif URL"
},
"triggerElementHints": {
  "message": "Indices d'element (optionnel)",
  "description": "Label pour les indices d'element"
},
"triggerModeSuggest": {
  "message": "Suggerer",
  "description": "Option mode suggestion"
},
"triggerModeAutoExecute": {
  "message": "Auto-executer",
  "description": "Option mode auto-execution"
},
"triggerModeLabel": {
  "message": "Quand les conditions sont remplies :",
  "description": "Label pour la selection du mode"
},
"triggerEnabled": {
  "message": "Active",
  "description": "Label case a cocher activer"
},
"triggerSave": {
  "message": "Sauvegarder le trigger",
  "description": "Bouton sauvegarder trigger"
},
"triggerDelete": {
  "message": "Supprimer",
  "description": "Bouton supprimer trigger"
},
"triggerAddCondition": {
  "message": "Ajouter une condition",
  "description": "Bouton ajouter condition"
},
"suggestedScriptsTitle": {
  "message": "Scripts suggeres",
  "description": "Titre de la section scripts suggeres"
},
"suggestedScriptsEmpty": {
  "message": "Aucun script ne correspond au contexte actuel",
  "description": "Etat vide pour les suggestions"
},
"suggestedScriptRun": {
  "message": "Executer",
  "description": "Bouton executer script suggere"
},
"notificationAutoExecuteTitle": {
  "message": "Script en auto-execution",
  "description": "Titre notification auto-execution"
},
"notificationAutoExecuteMessage": {
  "message": "Execution : $1",
  "description": "Message notification avec nom du script"
},
"notificationStop": {
  "message": "Arreter",
  "description": "Bouton arreter dans notification"
},
"notificationDisableSite": {
  "message": "Desactiver pour ce site",
  "description": "Bouton desactiver pour ce site"
},
"notificationCompleteTitle": {
  "message": "Script termine",
  "description": "Titre notification completion"
},
"notificationFailedTitle": {
  "message": "Script echoue",
  "description": "Titre notification echec"
},
"triggerCooldown": {
  "message": "Delai de refroidissement (minutes)",
  "description": "Label pour le parametre de cooldown"
}
```
  </action>
  <verify>
Check that JSON is valid in both files. Run `npm run build` to verify locale loading.
  </verify>
  <done>
i18n strings added for trigger UI in both EN and FR locales.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TriggerConfig component</name>
  <files>entrypoints/sidepanel/components/TriggerConfig.ts</files>
  <action>
Create the trigger configuration UI component following existing VanJS patterns:

```typescript
/**
 * TriggerConfig component for editing trigger conditions
 * Allows users to set URL patterns, element hints, and mode
 */

import van from 'vanjs-core';
import type { TriggerConfig as TriggerConfigType, TriggerCondition, TriggerMode } from '../../../utils/triggers/types';
import { getTriggers } from '../../../utils/storage/triggers';

const { div, h3, label, input, select, option, button, span, textarea } = van.tags;

// Helper to get i18n messages
const msg = (key: string, substitutions?: string[]): string =>
  chrome.i18n.getMessage(key, substitutions) || key;

interface TriggerConfigProps {
  scriptId: string;
  onClose: () => void;
}

/**
 * TriggerConfig component
 */
export function TriggerConfig({ scriptId, onClose }: TriggerConfigProps) {
  // State
  const triggers = van.state<TriggerConfigType[]>([]);
  const isLoading = van.state(true);
  const isSaving = van.state(false);

  // Current editing state
  const urlPattern = van.state('');
  const mode = van.state<TriggerMode>('suggest');
  const enabled = van.state(true);
  const cooldownMin = van.state(5);
  const editingId = van.state<string | null>(null);

  // Load existing triggers
  async function loadTriggers(): Promise<void> {
    isLoading.val = true;
    try {
      triggers.val = await getTriggers(scriptId);
    } finally {
      isLoading.val = false;
    }
  }

  // Save trigger
  async function saveTrigger(): Promise<void> {
    if (!urlPattern.val.trim()) return;

    isSaving.val = true;
    try {
      const condition: TriggerCondition = {
        url_pattern: urlPattern.val.trim()
      };

      const trigger: TriggerConfigType = {
        id: editingId.val || crypto.randomUUID(),
        scriptId,
        name: `URL: ${urlPattern.val}`,
        conditions: [condition],
        mode: mode.val,
        enabled: enabled.val,
        cooldownMs: cooldownMin.val * 60 * 1000,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      await chrome.runtime.sendMessage({
        type: 'SAVE_TRIGGER',
        payload: trigger
      });

      // Reset form and reload
      resetForm();
      await loadTriggers();
    } finally {
      isSaving.val = false;
    }
  }

  // Delete trigger
  async function deleteTrigger(triggerId: string): Promise<void> {
    await chrome.runtime.sendMessage({
      type: 'DELETE_TRIGGER',
      payload: triggerId
    });
    await loadTriggers();
  }

  // Edit existing trigger
  function editTrigger(trigger: TriggerConfigType): void {
    editingId.val = trigger.id;
    urlPattern.val = trigger.conditions[0]?.url_pattern || '';
    mode.val = trigger.mode;
    enabled.val = trigger.enabled;
    cooldownMin.val = Math.round((trigger.cooldownMs || 300000) / 60000);
  }

  // Reset form
  function resetForm(): void {
    editingId.val = null;
    urlPattern.val = '';
    mode.val = 'suggest';
    enabled.val = true;
    cooldownMin.val = 5;
  }

  // Initial load
  loadTriggers();

  return div({ class: 'trigger-config p-4' },
    // Header
    div({ class: 'flex justify-between items-center mb-4' },
      h3({ class: 'text-lg font-semibold' }, msg('triggerConfigTitle')),
      button({
        class: 'text-gray-500 hover:text-gray-700',
        onclick: onClose
      }, '\u00D7')
    ),

    // Form
    div({ class: 'space-y-4 mb-6' },
      // URL Pattern
      div(
        label({ class: 'block text-sm font-medium mb-1' }, msg('triggerUrlPattern')),
        input({
          type: 'text',
          class: 'w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500',
          placeholder: msg('triggerUrlPatternPlaceholder'),
          value: urlPattern,
          oninput: (e: Event) => { urlPattern.val = (e.target as HTMLInputElement).value; }
        })
      ),

      // Mode
      div(
        label({ class: 'block text-sm font-medium mb-1' }, msg('triggerModeLabel')),
        select({
          class: 'w-full px-3 py-2 border rounded',
          value: mode,
          onchange: (e: Event) => { mode.val = (e.target as HTMLSelectElement).value as TriggerMode; }
        },
          option({ value: 'suggest' }, msg('triggerModeSuggest')),
          option({ value: 'auto_execute' }, msg('triggerModeAutoExecute'))
        )
      ),

      // Cooldown (only for auto-execute)
      () => mode.val === 'auto_execute' ? div(
        label({ class: 'block text-sm font-medium mb-1' }, msg('triggerCooldown')),
        input({
          type: 'number',
          class: 'w-full px-3 py-2 border rounded',
          min: 1,
          max: 60,
          value: cooldownMin,
          oninput: (e: Event) => { cooldownMin.val = parseInt((e.target as HTMLInputElement).value) || 5; }
        })
      ) : null,

      // Enabled
      div({ class: 'flex items-center gap-2' },
        input({
          type: 'checkbox',
          id: 'trigger-enabled',
          checked: enabled,
          onchange: (e: Event) => { enabled.val = (e.target as HTMLInputElement).checked; }
        }),
        label({ for: 'trigger-enabled', class: 'text-sm' }, msg('triggerEnabled'))
      ),

      // Buttons
      div({ class: 'flex gap-2' },
        button({
          class: 'flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50',
          disabled: () => isSaving.val || !urlPattern.val.trim(),
          onclick: saveTrigger
        }, () => editingId.val ? msg('triggerSave') : msg('triggerSave')),

        () => editingId.val ? button({
          class: 'px-4 py-2 border rounded hover:bg-gray-100',
          onclick: resetForm
        }, 'Cancel') : null
      )
    ),

    // Existing triggers list
    div({ class: 'border-t pt-4' },
      h3({ class: 'text-sm font-medium mb-2' }, 'Existing Triggers'),

      () => isLoading.val
        ? div({ class: 'text-gray-500 text-sm' }, 'Loading...')
        : triggers.val.length === 0
          ? div({ class: 'text-gray-500 text-sm' }, 'No triggers configured')
          : div({ class: 'space-y-2' },
              ...triggers.val.map(trigger =>
                div({ class: 'flex items-center justify-between p-2 bg-gray-50 rounded' },
                  div({ class: 'flex-1' },
                    span({ class: 'text-sm font-medium' }, trigger.name),
                    span({
                      class: `ml-2 text-xs px-2 py-0.5 rounded ${trigger.mode === 'suggest' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}`
                    }, trigger.mode),
                    !trigger.enabled ? span({ class: 'ml-2 text-xs text-gray-400' }, '(disabled)') : null
                  ),
                  div({ class: 'flex gap-1' },
                    button({
                      class: 'text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded',
                      onclick: () => editTrigger(trigger)
                    }, 'Edit'),
                    button({
                      class: 'text-xs px-2 py-1 text-red-600 hover:bg-red-50 rounded',
                      onclick: () => deleteTrigger(trigger.id)
                    }, msg('triggerDelete'))
                  )
                )
              )
            )
    )
  );
}
```

Key features:
- Form for URL pattern input (element hints deferred - simpler v1)
- Mode selection (suggest/auto-execute)
- Cooldown setting for auto-execute
- Enable/disable toggle
- List of existing triggers with edit/delete
- Uses VanJS reactive state patterns
  </action>
  <verify>
Run `npx tsc --noEmit entrypoints/sidepanel/components/TriggerConfig.ts` - should compile.
  </verify>
  <done>
TriggerConfig component exists with URL pattern input, mode selection, enable/disable, trigger list with edit/delete.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SuggestedScripts component</name>
  <files>entrypoints/sidepanel/components/SuggestedScripts.ts</files>
  <action>
Create the suggested scripts display component:

```typescript
/**
 * SuggestedScripts component displays context-matched scripts
 * Shows scripts that match the current page context
 */

import van from 'vanjs-core';
import type { Script } from '../../../utils/types';
import { getScripts } from '../../../utils/storage/scripts';
import { suggestedScriptIds, clearSuggestions } from '../stores/triggers';

const { div, h3, p, button, span } = van.tags;

// Helper to get i18n messages
const msg = (key: string): string => chrome.i18n.getMessage(key) || key;

interface SuggestedScriptsProps {
  onRunScript: (script: Script) => void;
}

/**
 * SuggestedScripts component
 */
export function SuggestedScripts({ onRunScript }: SuggestedScriptsProps) {
  // State
  const scripts = van.state<Script[]>([]);
  const isLoading = van.state(false);

  // Load suggested scripts when IDs change
  van.derive(async () => {
    const ids = suggestedScriptIds.val;
    if (ids.length === 0) {
      scripts.val = [];
      return;
    }

    isLoading.val = true;
    try {
      const allScripts = await getScripts();
      scripts.val = allScripts.filter(s => ids.includes(s.id));
    } finally {
      isLoading.val = false;
    }
  });

  // Load on mount - check session storage for current tab
  async function loadSuggestions(): Promise<void> {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'GET_SUGGESTED_SCRIPTS'
      });
      if (response.success && response.data) {
        suggestedScriptIds.val = response.data as string[];
      }
    } catch {
      // Ignore errors
    }
  }

  // Initial load
  loadSuggestions();

  // Listen for tab changes to refresh suggestions
  chrome.tabs.onActivated.addListener(() => {
    loadSuggestions();
  });

  return div({ class: 'suggested-scripts' },
    // Header
    div({ class: 'flex justify-between items-center mb-3' },
      h3({ class: 'text-sm font-semibold flex items-center gap-2' },
        span({ class: 'w-2 h-2 rounded-full bg-blue-500 animate-pulse' }),
        msg('suggestedScriptsTitle')
      ),
      () => scripts.val.length > 0
        ? button({
            class: 'text-xs text-gray-500 hover:text-gray-700',
            onclick: () => {
              clearSuggestions();
              // Clear badge for current tab
              chrome.tabs.query({ active: true, currentWindow: true }, tabs => {
                if (tabs[0]?.id) {
                  chrome.action.setBadgeText({ text: '', tabId: tabs[0].id });
                }
              });
            }
          }, 'Dismiss')
        : null
    ),

    // Content
    () => isLoading.val
      ? div({ class: 'text-gray-500 text-sm py-2' }, 'Loading...')
      : scripts.val.length === 0
        ? div({ class: 'text-gray-400 text-sm py-2' }, msg('suggestedScriptsEmpty'))
        : div({ class: 'space-y-2' },
            ...scripts.val.map(script =>
              div({ class: 'flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100' },
                div({ class: 'flex-1 min-w-0' },
                  div({ class: 'font-medium text-sm truncate' }, script.name),
                  script.description
                    ? div({ class: 'text-xs text-gray-500 truncate' }, script.description)
                    : null
                ),
                button({
                  class: 'ml-2 px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 flex-shrink-0',
                  onclick: () => onRunScript(script)
                }, msg('suggestedScriptRun'))
              )
            )
          )
  );
}

/**
 * Badge indicator for when suggestions are available
 * Can be added to navigation/header
 */
export function SuggestionBadge() {
  return () => suggestedScriptIds.val.length > 0
    ? span({
        class: 'inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-500 rounded-full'
      }, String(suggestedScriptIds.val.length))
    : null;
}
```

Key features:
- Reactive to suggestedScriptIds store changes
- Fetches full script details when IDs available
- Run button triggers script execution
- Dismiss clears suggestions and badge
- Empty state when no matches
- Blue highlight to draw attention
  </action>
  <verify>
Run `npx tsc --noEmit entrypoints/sidepanel/components/SuggestedScripts.ts` - should compile.
  </verify>
  <done>
SuggestedScripts component exists with script list, run buttons, dismiss functionality, empty state.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` - Full project builds
2. i18n strings present in both EN and FR locales
3. TriggerConfig renders with form and trigger list
4. SuggestedScripts renders with matched scripts
5. Components use existing VanJS patterns
</verification>

<success_criteria>
- [ ] i18n strings added to en/messages.json and fr/messages.json
- [ ] entrypoints/sidepanel/components/TriggerConfig.ts exists with trigger form
- [ ] entrypoints/sidepanel/components/SuggestedScripts.ts exists with suggestions display
- [ ] TriggerConfig saves triggers via SAVE_TRIGGER message
- [ ] SuggestedScripts fetches suggestions via GET_SUGGESTED_SCRIPTS message
- [ ] Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-contextual-triggers/06-05-SUMMARY.md`
</output>
