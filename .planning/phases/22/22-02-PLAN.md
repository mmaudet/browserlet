---
phase: 22-firefox-validation
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - entrypoints/content/playback/cascadeResolver.ts
  - entrypoints/background/llm/microPromptRouter.ts
  - entrypoints/background/llm/providers/claude.ts
  - entrypoints/background/llm/providers/ollama.ts
  - entrypoints/background/llm/providers/openai.ts
autonomous: false

must_haves:
  truths:
    - "Playback resolves elements identically on Chrome and Firefox using cascadeResolver stages 1-2"
    - "Recording captures identical semantic hints on Chrome and Firefox"
    - "Micro-prompt routing (MICRO_PROMPT_REQUEST) works through Firefox background service worker"
    - "All three LLM providers (Claude, Ollama, OpenAI Compatible) make successful API calls from Firefox background"
    - "Credential vault (setup, lock, unlock, save, retrieve) works in Firefox"
    - "Hint stability data persists and loads correctly in Firefox storage"
    - "Sidebar UI (script list, editor, recording, settings, credentials) renders correctly in Firefox"
  artifacts:
    - path: "entrypoints/content/playback/cascadeResolver.ts"
      provides: "Cross-browser cascade resolution"
      contains: "resolveElementCascade"
    - path: "entrypoints/background/llm/microPromptRouter.ts"
      provides: "Cross-browser micro-prompt routing"
      contains: "routeMicroPrompt"
    - path: "entrypoints/background/messaging.ts"
      provides: "Message routing for all features"
      contains: "MICRO_PROMPT_REQUEST"
  key_links:
    - from: "entrypoints/content/playback/cascadeResolver.ts"
      to: "entrypoints/background/messaging.ts"
      via: "chrome.runtime.sendMessage MICRO_PROMPT_REQUEST"
      pattern: "sendMicroPrompt"
    - from: "entrypoints/content/playback/hintStabilityTracker.ts"
      to: "utils/storage/browserCompat.ts"
      via: "storage.local.get/set"
      pattern: "storage\\.local\\."
    - from: "entrypoints/background/llm/providers/claude.ts"
      to: "https://api.anthropic.com"
      via: "Anthropic SDK fetch"
      pattern: "messages\\.create"
---

<objective>
Systematically validate that ALL extension features work identically in Firefox: playback resolution (cascade stages 1-5), recording (event capture + hint generation + BSL generation), micro-prompts, LLM integration, credentials, storage, and sidebar UI.

Purpose: This is the core cross-browser validation plan. Each feature area is tested by examining code for Firefox-incompatible patterns and fixing any issues found. The goal is FFOX-02 through FFOX-06 coverage.

Output: All features verified working in Firefox with any necessary code fixes applied. Validation checklist documented.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22/22-01-SUMMARY.md
@entrypoints/content/playback/cascadeResolver.ts
@entrypoints/content/playback/hintStabilityTracker.ts
@entrypoints/content/playback/semanticResolver.ts
@entrypoints/content/recording/eventCapture.ts
@entrypoints/background/messaging.ts
@entrypoints/background/llm/microPromptRouter.ts
@entrypoints/background/llm/providers/claude.ts
@entrypoints/background/llm/providers/ollama.ts
@entrypoints/background/llm/providers/openai.ts
@entrypoints/background/llm/fallback.ts
@entrypoints/background/llm/promptBuilder.ts
@entrypoints/background/llm/providers/types.ts
@entrypoints/sidepanel/components/LLMSettings.tsx
@utils/storage/browserCompat.ts
@utils/firefoxPolyfill.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-browser code audit -- playback, recording, and LLM subsystems</name>
  <files>
    entrypoints/content/playback/cascadeResolver.ts
    entrypoints/background/llm/microPromptRouter.ts
    entrypoints/background/llm/providers/claude.ts
    entrypoints/background/llm/providers/ollama.ts
    entrypoints/background/llm/providers/openai.ts
  </files>
  <action>
Perform a systematic code audit of each subsystem for Firefox MV3 compatibility. For each area, check the specific concern listed, and fix if needed.

**A. Playback / CascadeResolver (FFOX-02)**
- cascadeResolver.ts uses `chrome.runtime.sendMessage` (line 240) for micro-prompts and `chrome.storage.local.get` (line 269) for config. Both work via firefoxPolyfill alias. Verify no other Chrome-only APIs are used.
- `performance.now()` is used for timing -- works identically on Firefox. No fix needed.
- `document.querySelectorAll`, `getBoundingClientRect`, `MutationObserver` -- all standard DOM APIs, work identically. No fix needed.
- `window.location.href` and `window.location.hostname` -- standard, works identically. No fix needed.
- **Structural resolution**: domContextExtractor.ts uses only DOM traversal (`closest`, `querySelector`, `previousElementSibling`). All standard. No fix needed.
- **Stability tracker**: hintStabilityTracker.ts uses `storage` from browserCompat (line 13). This is correct cross-browser usage.

**B. Recording / EventCapture (FFOX-03)**
- eventCapture.ts uses standard DOM events (`click`, `input`, `submit` via `addEventListener`). No Chrome-specific APIs.
- hintGenerator.ts uses DOM inspection (`getAttribute`, `textContent`, `closest`). Standard APIs.
- **BSL generation**: Both fallback.ts (deterministic) and promptBuilder.ts (LLM) use pure data transformation -- no browser APIs. Generation happens in background service worker which has the same capabilities on both browsers.

**C. LLM Providers (FFOX-06)**
- **Claude provider**: Uses `@anthropic-ai/sdk` which internally uses `fetch()`. Firefox MV3 service workers support `fetch()`. The `dangerouslyAllowBrowser: true` flag is needed for both browsers. Verify the SDK does not use any Chrome-specific APIs (it doesn't -- it's a standard HTTP client).
- **Ollama provider**: Uses `ollama/browser` package which also uses `fetch()`. Works identically on Firefox. The host_permissions in manifest include `http://localhost:11434/*` and `http://127.0.0.1:11434/*` for both browsers (wxt.config.ts line 71-74).
- **OpenAI provider**: Uses raw `fetch()` directly. Works identically on Firefox.
- **Micro-prompt router**: Uses `getLLMService()` and `buildMicroPrompt()` -- pure logic, no browser APIs. The dynamic import (`await import('./llm/microPromptRouter')` in messaging.ts line 164) works in both browsers' service workers.

**D. Messaging (all features)**
- `chrome.runtime.onMessage.addListener` in background -- works via polyfill.
- `chrome.runtime.sendMessage` in content/sidepanel -- works via polyfill.
- `chrome.tabs.query` and `chrome.tabs.sendMessage` -- work via polyfill.
- `chrome.tabs.captureVisibleTab` (screenshot) -- works in Firefox MV3 (requires `activeTab` permission, which is in both permission sets).

**E. Credentials (FFOX-05)**
- Password vault uses `chrome.storage.local` for encrypted data -- works via polyfill.
- WebCrypto API (`crypto.subtle`) for encryption -- available in Firefox service workers.

**F. Fix any issues found during audit.** If the Anthropic SDK has issues with Firefox service workers (known issue: some SDKs check `navigator.userAgent` or use `XMLHttpRequest`), add a note. The SDK v0.71.2 uses `fetch()` natively, so it should be fine.

After audit, run both builds:
- `npm run build:firefox` -- zero errors
- `npm run build` -- zero errors
  </action>
  <verify>
    Both builds pass: `npm run build:firefox && npm run build`
    No Chrome-only APIs used without guards (search for `chrome.sidePanel`, `chrome.scripting` outside of guarded blocks).
    Run: `grep -rn "chrome\.sidePanel\|chrome\.scripting" entrypoints/ utils/ --include="*.ts" --include="*.tsx" | grep -v "isFirefox"` -- results should only be in already-guarded blocks or wxt.config.ts.
  </verify>
  <done>
    All subsystems (playback, recording, LLM, messaging, credentials, storage) audited for Firefox compatibility.
    No unguarded Chrome-only API calls remain.
    Any fixes applied and both builds pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual Firefox functional verification</name>
  <what-built>
    Plan 22-01 fixed build issues and chrome.scripting guards.
    Task 1 of this plan audited all subsystems for Firefox compatibility and applied fixes.
    The extension should now work fully in Firefox.
  </what-built>
  <how-to-verify>
    Load the Firefox extension and verify each feature area:

    **Setup:**
    1. Run `npm run build:firefox` to build the extension
    2. Open Firefox, navigate to `about:debugging#/runtime/this-firefox`
    3. Click "Load Temporary Add-on" and select any file in `.output/firefox-mv3/` directory
    4. The Browserlet sidebar should appear (click the extension icon in toolbar, or View > Sidebar > Browserlet)

    **Test 1: Sidebar UI (FFOX-04)**
    - Verify sidebar opens and shows the credential setup / vault unlock screen
    - Set up a master password, verify vault unlocks
    - Navigate between tabs: Scripts, Record, Credentials, Settings
    - Verify all navigation works, no console errors

    **Test 2: Recording (FFOX-03)**
    - Navigate to any website (e.g., https://example.com or a form page)
    - Start recording from the Record tab
    - Perform a few actions: click a link, type in a field if available
    - Stop recording
    - Verify BSL script is generated (either fallback or LLM if configured)
    - Open the generated script in editor, verify YAML is valid

    **Test 3: Playback (FFOX-02)**
    - Open a generated script (or create a simple one manually)
    - Run playback
    - Verify actions execute (elements are found and interacted with)

    **Test 4: Settings / LLM (FFOX-06)**
    - Open Settings tab
    - If you have an Ollama instance running locally, configure it and test connection
    - Verify the settings save and persist across sidebar close/reopen

    **Test 5: Storage persistence (FFOX-05)**
    - Create a script, close and reopen the sidebar, verify script persists
    - Save credentials, lock vault, unlock, verify credentials are still there

    Report any issues found. Type "approved" if all features work, or describe specific failures.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Code audit confirms no unguarded Chrome-only APIs
2. Both builds pass with zero errors
3. Human verification confirms all features work in Firefox
4. Recording produces equivalent BSL on Firefox
5. Playback resolves elements correctly on Firefox
6. LLM settings save and load on Firefox
7. Credentials vault works on Firefox
</verification>

<success_criteria>
- FFOX-02 satisfied: Playback produces identical results on Chrome and Firefox
- FFOX-03 satisfied: Recording produces equivalent BSL output on both browsers
- FFOX-04 satisfied: Firefox sidebar provides equivalent functionality to Chrome side panel
- FFOX-05 satisfied: All storage operations work correctly in Firefox
- FFOX-06 satisfied: LLM integration works identically in Firefox
- Human has verified the extension works end-to-end in Firefox
</success_criteria>

<output>
After completion, create `.planning/phases/22/22-02-SUMMARY.md`
</output>
