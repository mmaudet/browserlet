---
phase: 22-firefox-validation
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - .github/workflows/build.yml
  - docs/BROWSER_COMPATIBILITY.md
  - CONTRIBUTING.md
autonomous: true

must_haves:
  truths:
    - "CI pipeline builds both Chrome and Firefox targets on every push/PR"
    - "Build failures on either target block the PR"
    - "Browser compatibility matrix documents which features work on which browser"
    - "CONTRIBUTING.md includes Firefox development instructions"
  artifacts:
    - path: ".github/workflows/build.yml"
      provides: "CI workflow with dual-browser builds"
      contains: "build:firefox"
    - path: "docs/BROWSER_COMPATIBILITY.md"
      provides: "Cross-browser compatibility matrix"
      contains: "Firefox"
    - path: "CONTRIBUTING.md"
      provides: "Updated contributing guide with Firefox instructions"
      contains: "Firefox"
  key_links:
    - from: ".github/workflows/build.yml"
      to: "package.json"
      via: "npm run build and npm run build:firefox scripts"
      pattern: "npm run build"
---

<objective>
Create CI pipeline for Firefox builds and document the browser compatibility matrix so future contributors know what works where.

Purpose: Prevent Firefox regressions with automated CI checks. Provide clear documentation of cross-browser compatibility status and browser-specific first-run instructions.

Output: GitHub Actions workflow with dual-browser builds, comprehensive compatibility matrix document, updated CONTRIBUTING.md.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22/22-01-SUMMARY.md
@package.json
@wxt.config.ts
@CONTRIBUTING.md
@utils/browser-detect.ts
@entrypoints/background/index.ts
@entrypoints/background/triggers/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Actions CI workflow for dual-browser builds</name>
  <files>
    .github/workflows/build.yml
  </files>
  <action>
Create `.github/workflows/build.yml` with the following configuration:

```yaml
name: Build & Verify

on:
  push:
    branches: [main, firefox]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Build for ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            npm run build:firefox
          else
            npm run build
          fi
      - name: Verify output exists
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            test -d .output/firefox-mv3
          else
            test -d .output/chrome-mv3
          fi
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: browserlet-${{ matrix.browser }}
          path: .output/${{ matrix.browser }}-mv3/
          retention-days: 7
```

Key design decisions:
- Matrix strategy builds Chrome AND Firefox in parallel (fast feedback)
- Both must pass for the workflow to succeed (matrix failure = overall failure)
- Build artifacts uploaded for 7 days (useful for QA testing without building locally)
- Runs on push to main/firefox branches and all PRs to main
- Uses `npm ci` for reproducible installs
- Node 20 (LTS) with npm cache for fast installs
  </action>
  <verify>
    File exists: `ls .github/workflows/build.yml`
    YAML is valid: `node -e "const yaml = require('js-yaml'); yaml.load(require('fs').readFileSync('.github/workflows/build.yml', 'utf8')); console.log('VALID');"` (run from project root, uses the js-yaml dependency already in the project)
    Contains both browser targets: `grep -c "build:firefox\|npm run build" .github/workflows/build.yml` should show 2+ matches
  </verify>
  <done>
    GitHub Actions workflow exists at .github/workflows/build.yml.
    Builds both Chrome and Firefox in parallel matrix.
    Both must pass for CI to be green.
    Build artifacts uploaded for download.
  </done>
</task>

<task type="auto">
  <name>Task 2: Browser compatibility matrix and updated documentation</name>
  <files>
    docs/BROWSER_COMPATIBILITY.md
    CONTRIBUTING.md
  </files>
  <action>
1. Create `docs/BROWSER_COMPATIBILITY.md` with a comprehensive compatibility matrix:

```markdown
# Browser Compatibility Matrix

## Build Commands

| Browser | Dev Server | Production Build | Package (zip) |
|---------|-----------|-----------------|---------------|
| Chrome | `npm run dev` | `npm run build` | `npm run zip` |
| Firefox | `npm run dev:firefox` | `npm run build:firefox` | `npm run zip:firefox` |

## Feature Compatibility

| Feature | Chrome MV3 | Firefox MV3 | Notes |
|---------|-----------|-------------|-------|
| **Sidebar** | sidePanel API | sidebar_action API | Different APIs, same UX |
| **Recording** | Full support | Full support | Standard DOM event listeners |
| **Playback** | Full support | Full support | Cascade resolver uses standard DOM APIs |
| **BSL Generation (Fallback)** | Full support | Full support | Pure data transformation, no browser APIs |
| **BSL Generation (LLM)** | Full support | Full support | Uses fetch() in service worker |
| **Semantic Resolver** | Full support | Full support | DOM queries + scoring |
| **Cascade Resolver (Stages 1-2)** | Full support | Full support | Deterministic resolution |
| **Micro-Prompts (Stages 3-5)** | Full support | Full support | Messages via chrome.runtime (polyfilled) |
| **Claude API** | Full support | Full support | @anthropic-ai/sdk uses fetch() |
| **Ollama** | Full support | Full support | ollama/browser uses fetch() |
| **OpenAI Compatible** | Full support | Full support | Raw fetch() calls |
| **Credential Vault** | Full support | Full support | WebCrypto + storage.local |
| **Script Storage** | Full support | Full support | storage.local via polyfill |
| **Hint Stability** | Full support | Full support | storage.local via polyfill |
| **Screenshots** | Full support | Full support | tabs.captureVisibleTab (activeTab) |
| **Triggers/Auto-execute** | Full support | Full support | Standard messaging |
| **Notifications** | Buttons supported | Basic only | Firefox lacks notification buttons |
| **Content Script Injection** | chrome.scripting API | Manifest-only | Firefox uses auto-registered content scripts |
| **Monaco Editor** | Full support | Full support | Inline script extracted to external file |

## Browser-Specific Code Locations

| File | What | Chrome | Firefox |
|------|------|--------|---------|
| `wxt.config.ts` | Manifest generation | sidePanel permission, side_panel config | sidebar_action config |
| `utils/firefoxPolyfill.ts` | API aliasing | No-op | Replaces chrome.* with browser.* |
| `utils/browser-detect.ts` | Build-time detection | isChrome = true | isFirefox = true |
| `utils/storage/browserCompat.ts` | Storage API | chrome.storage | browser.storage |
| `entrypoints/background/index.ts` | Sidebar open | chrome.sidePanel.open | browser.sidebarAction.toggle |
| `entrypoints/background/triggers/notifications.ts` | Notifications | Buttons included | Buttons omitted |
| `entrypoints/sidepanel/components/RecordingView.tsx` | Script injection | chrome.scripting.executeScript | Skipped (auto-registered) |
| `entrypoints/sidepanel/components/CredentialManager.tsx` | Script injection | chrome.scripting.executeScript | Skipped (auto-registered) |

## First-Run Instructions

### Chrome
1. Run `npm run build` or `npm run dev`
2. Open `chrome://extensions`, enable Developer Mode
3. Click "Load unpacked", select `.output/chrome-mv3`
4. Click the Browserlet icon in toolbar to open the side panel

### Firefox
1. Run `npm run build:firefox` or `npm run dev:firefox`
2. Open `about:debugging#/runtime/this-firefox`
3. Click "Load Temporary Add-on", select any file in `.output/firefox-mv3`
4. Click the Browserlet icon in toolbar (or View > Sidebar > Browserlet) to open the sidebar
5. Note: Temporary add-ons are removed when Firefox closes. For persistent installation, use `npm run zip:firefox` and install from the generated .xpi file.

## Known Differences

1. **Notification buttons**: Firefox does not support `chrome.notifications` button actions. Auto-execute notifications show text-only on Firefox (no Stop/Disable buttons). In-page notifications still work.

2. **Content script injection**: Firefox does not support `chrome.scripting.executeScript` without the `scripting` permission. Content scripts are auto-registered via WXT manifest. If a content script is not loaded on a page, the user must refresh the page.

3. **Sidebar lifecycle**: Chrome's sidePanel is per-tab. Firefox's sidebar_action is global (opens for all tabs). Same HTML/JS, different scoping.

4. **Service worker lifecycle**: Firefox MV3 uses event pages that may have slightly different lifecycle behavior than Chrome's service workers. The extension handles this via synchronous listener registration at the top of the background entry point.
```

2. Update `CONTRIBUTING.md` to enhance the Firefox section:

Read the current CONTRIBUTING.md. After the "Development" section's code block (after `npm run build:firefox`), add a new subsection:

```markdown
### Loading the Extension

**Chrome:**
1. Run `npm run build` (production) or `npm run dev` (with HMR)
2. Open `chrome://extensions`, enable Developer Mode
3. Click "Load unpacked", select `.output/chrome-mv3`

**Firefox:**
1. Run `npm run build:firefox` (production) or `npm run dev:firefox` (with HMR)
2. Open `about:debugging#/runtime/this-firefox`
3. Click "Load Temporary Add-on", select any file in `.output/firefox-mv3`
4. Note: Temporary add-ons are removed when Firefox closes

For detailed browser compatibility information, see [docs/BROWSER_COMPATIBILITY.md](docs/BROWSER_COMPATIBILITY.md).
```
  </action>
  <verify>
    File exists: `ls docs/BROWSER_COMPATIBILITY.md`
    Contains feature matrix: `grep -c "Full support" docs/BROWSER_COMPATIBILITY.md` should show 15+ matches
    CONTRIBUTING.md updated: `grep "about:debugging" CONTRIBUTING.md` should match
    Both builds still pass: `npm run build:firefox && npm run build`
  </verify>
  <done>
    docs/BROWSER_COMPATIBILITY.md exists with comprehensive feature matrix, browser-specific code locations, first-run instructions, and known differences.
    CONTRIBUTING.md updated with Firefox loading instructions and link to compatibility docs.
    .github/workflows/build.yml provides CI for both browsers.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/build.yml` exists with matrix strategy for Chrome + Firefox
2. `docs/BROWSER_COMPATIBILITY.md` exists with feature matrix covering all 18+ features
3. `CONTRIBUTING.md` includes Firefox first-run instructions
4. All documentation is accurate (reflects actual codebase state)
5. Both `npm run build` and `npm run build:firefox` still pass
</verification>

<success_criteria>
- CI pipeline will catch Firefox build regressions on every push/PR
- Contributors can quickly understand what works where via the compatibility matrix
- First-run instructions for both browsers are clear and actionable
- Browser-specific code locations are documented for future maintenance
</success_criteria>

<output>
After completion, create `.planning/phases/22/22-03-SUMMARY.md`
</output>
