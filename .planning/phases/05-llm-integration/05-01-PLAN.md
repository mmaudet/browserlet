---
phase: 05-llm-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - wxt.config.ts
  - utils/crypto/encryption.ts
autonomous: true

must_haves:
  truths:
    - "Dependencies installed without errors"
    - "Extension loads with new host_permissions"
    - "API keys can be encrypted and decrypted"
  artifacts:
    - path: "package.json"
      provides: "LLM SDK dependencies"
      contains: "@anthropic-ai/sdk"
    - path: "wxt.config.ts"
      provides: "Host permissions for API calls"
      contains: "api.anthropic.com"
    - path: "utils/crypto/encryption.ts"
      provides: "AES-GCM encryption for API keys"
      exports: ["encryptApiKey", "decryptApiKey", "getOrCreateSessionKey"]
  key_links:
    - from: "utils/crypto/encryption.ts"
      to: "chrome.storage.session"
      via: "getOrCreateSessionKey stores key in session storage"
      pattern: "chrome\\.storage\\.session"
---

<objective>
Install LLM integration dependencies and create encryption utilities for secure API key storage.

Purpose: Foundation for all LLM features - SDKs for Claude/Ollama, rate limiting library, and secure credential storage using Web Crypto API.
Output: Dependencies installed, manifest updated with host_permissions, encryption utilities ready.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-llm-integration/05-RESEARCH.md

# Existing files to modify
@wxt.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install LLM dependencies</name>
  <files>package.json</files>
  <action>
Run npm install to add the three required packages:
- @anthropic-ai/sdk: Official Anthropic SDK for Claude API
- ollama: Official Ollama client with browser bundle (ollama/browser)
- exponential-backoff: Retry logic with jitter for rate limit handling

Command: npm install @anthropic-ai/sdk ollama exponential-backoff

After install, verify package.json has the new dependencies.
  </action>
  <verify>npm ls @anthropic-ai/sdk ollama exponential-backoff shows all three installed without errors</verify>
  <done>All three packages appear in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Update manifest with host_permissions</name>
  <files>wxt.config.ts</files>
  <action>
Add host_permissions array to wxt.config.ts manifest section for:
- https://api.anthropic.com/* (Claude API)
- http://localhost:11434/* (Ollama default)
- http://127.0.0.1:11434/* (Ollama alternative)

This allows the service worker to make cross-origin requests to these APIs without CORS issues.

Update the manifest object in wxt.config.ts:
```typescript
manifest: {
  // ... existing config
  permissions: ['storage', 'sidePanel', 'tabs', 'activeTab'],
  host_permissions: [
    'https://api.anthropic.com/*',
    'http://localhost:11434/*',
    'http://127.0.0.1:11434/*'
  ],
  // ... rest of config
}
```
  </action>
  <verify>npm run build succeeds and outputs manifest.json with host_permissions array</verify>
  <done>wxt.config.ts includes host_permissions for Claude API and Ollama</done>
</task>

<task type="auto">
  <name>Task 3: Create encryption utilities</name>
  <files>utils/crypto/encryption.ts</files>
  <action>
Create utils/crypto/encryption.ts implementing AES-GCM encryption for API keys.

The encryption key is stored in chrome.storage.session (memory-only, cleared on browser restart) for security. API keys encrypted with this key are stored in chrome.storage.local.

Implement three exported functions:

1. getOrCreateSessionKey(): Promise<CryptoKey>
   - Check chrome.storage.session for existing key
   - If exists, import from JWK format
   - If not, generate new AES-GCM 256-bit key
   - Store as JWK in session storage
   - Return the CryptoKey

2. encryptApiKey(apiKey: string): Promise<EncryptedData>
   - Get session key via getOrCreateSessionKey()
   - Generate random 12-byte IV (96 bits for AES-GCM)
   - Encrypt using crypto.subtle.encrypt with AES-GCM
   - Return { ciphertext: base64, iv: base64 }

3. decryptApiKey(data: EncryptedData): Promise<string>
   - Get session key
   - Decode base64 ciphertext and IV
   - Decrypt using crypto.subtle.decrypt
   - Return plaintext string

Export EncryptedData interface:
```typescript
interface EncryptedData {
  ciphertext: string; // Base64 encoded
  iv: string;         // Base64 encoded
}
```

Use standard Web Crypto API patterns from research. Handle errors gracefully - if decryption fails (e.g., after browser restart with new session key), throw a clear error message.
  </action>
  <verify>Create a simple test: encrypt "test-key-123", then decrypt it, verify result matches original</verify>
  <done>encryption.ts exports getOrCreateSessionKey, encryptApiKey, decryptApiKey, and EncryptedData type</done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. .output/chrome-mv3/manifest.json contains host_permissions array
3. Encryption round-trip test passes (encrypt then decrypt returns original value)
</verification>

<success_criteria>
- All three npm packages installed and listed in package.json
- Manifest includes host_permissions for api.anthropic.com and localhost:11434
- Encryption utilities work correctly for string round-trip
- npm run dev starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-llm-integration/05-01-SUMMARY.md`
</output>
