---
phase: 035-bsl-integration-validation
plan: 02
type: execute
wave: 2
depends_on: ["035-01"]
files_modified:
  - packages/cli/src/runner.ts
  - packages/cli/src/index.ts
autonomous: true

must_haves:
  truths:
    - "CLI auto-captures session after successful run when parsed session_persistence.enabled is true"
    - "CLI auto-restores session before execution when parsed session_persistence.enabled is true and snapshot exists"
    - "CLI uses snapshot_id from BSL when provided instead of random session ID"
    - "CLI skips auto-capture/restore when session_persistence is absent or enabled is false"
    - "Manual --session-restore flag still works and takes precedence over BSL session_persistence"
  artifacts:
    - path: "packages/cli/src/runner.ts"
      provides: "Auto-capture/restore logic driven by parsed sessionPersistence"
      contains: "sessionPersistence"
    - path: "packages/cli/src/index.ts"
      provides: "Auto-restore integration from parsed session_persistence metadata"
      contains: "sessionPersistence"
  key_links:
    - from: "packages/cli/src/runner.ts"
      to: "packages/cli/src/session/storage.ts"
      via: "saveSessionSnapshot with snapshot_id from parsed metadata"
      pattern: "saveSessionSnapshot"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/session/storage.ts"
      via: "loadSessionWithMeta for auto-restore from parsed metadata"
      pattern: "loadSessionWithMeta"
---

<objective>
Wire CLI execution to automatically capture and restore sessions based on BSL session_persistence declarations. When a script declares `session_persistence: {enabled: true}`, the CLI auto-restores before execution and auto-captures after successful runs, using snapshot_id for stable session file names.

Purpose: BSL-03 (execution engine auto-captures/restores based on session_persistence.enabled). Makes session persistence zero-configuration for CLI users who add the declaration to their BSL scripts.

Output: CLI runner with auto-capture/restore driven by parsed BSL metadata
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/035-bsl-integration-validation/035-RESEARCH.md
@.planning/phases/035-bsl-integration-validation/035-01-SUMMARY.md

@packages/cli/src/runner.ts
@packages/cli/src/index.ts
@packages/cli/src/session/storage.ts
@packages/core/src/types/bsl.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI auto-capture from parsed session_persistence</name>
  <files>
    packages/cli/src/runner.ts
  </files>
  <action>
    In `packages/cli/src/runner.ts`, modify the `run()` method to read parsed session_persistence and auto-configure session capture:

    1. After `const script = parseSteps(yamlContent);` (line 96), add logic to auto-enable session capture from BSL metadata:
       ```typescript
       // Auto-enable session capture from BSL session_persistence declaration
       if (script.sessionPersistence?.enabled && !this.options.sessionId) {
         const snapshotId = script.sessionPersistence.snapshot_id || scriptBaseName;
         this.options.sessionId = snapshotId;
         console.log(`[Session] Auto-capture enabled via BSL session_persistence (id: ${snapshotId})`);
       }
       ```
       Note: Use `snapshot_id` directly as sessionId (NOT prefixed with "session-") to produce stable, meaningful file names. If the user runs the same script twice, the same session file is overwritten (desired behavior for session persistence). If snapshot_id is not provided, use scriptBaseName as a stable default.

    2. The existing session capture logic at lines 372-384 (`if (this.options.sessionId)`) works unchanged because we set `this.options.sessionId` above.

    3. Important: When `--session-restore` flag is used (handled in index.ts), `sessionId` is set to undefined (line 218: `sessionId: options.sessionRestore ? undefined : sessionId`). This means manual restore suppresses auto-capture, which is the correct behavior per decision "No session capture when restoring (avoid overwriting source session)".
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/cli/tsconfig.json` to verify types compile.
    Manually verify: `node packages/cli/dist/index.js run --help` shows existing options unchanged.
  </verify>
  <done>
    BSL scripts with session_persistence.enabled=true auto-configure session capture in CLI. Existing --session-restore behavior unchanged. Uses snapshot_id for stable session file names.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI auto-restore from parsed session_persistence</name>
  <files>
    packages/cli/src/index.ts
  </files>
  <action>
    In `packages/cli/src/index.ts`, modify the run command action to auto-restore sessions when BSL declares session_persistence:

    1. The current flow (lines 162-197):
       - If `--session-restore` provided: load that session, validate protocol, use it
       - Else: auto-generate random sessionId for capture

    2. Add a third path: parse the BSL script first to check for session_persistence, then auto-restore if a snapshot exists. Insert BEFORE the `--session-restore` handling (around line 162):

       ```typescript
       // Parse script to check for session_persistence declaration
       let parsedSessionPersistence: { enabled: boolean; snapshot_id?: string } | undefined;
       try {
         const yamlContent = fs.readFileSync(scriptPath, 'utf-8').replace(/[\u200B-\u200F\u2028-\u202F\uFEFF]/g, '');
         const parsed = parseSteps(yamlContent);
         parsedSessionPersistence = parsed.sessionPersistence;
       } catch {
         // Parse errors will be caught later in runner.run()
       }
       ```

    3. Modify the session handling block. The new logic:
       - If `--session-restore` is provided: use manual restore (existing behavior, takes precedence)
       - Else if `parsedSessionPersistence?.enabled`: try auto-restore from snapshot_id or script basename
       - Else: generate random sessionId for implicit capture (existing behavior)

       Replace the existing block (lines 162-197) with:
       ```typescript
       // Handle session restore/capture
       let sessionStorageState: import('./session/storage.js').PlaywrightStorageState | undefined;
       let sessionId: string | undefined;

       if (options.sessionRestore) {
         // Manual --session-restore takes precedence
         const snapshotData = await loadSessionWithMeta(options.sessionRestore);
         if (!snapshotData) {
           console.error(pc.red(`Session not found: ${options.sessionRestore}`));
           console.error(pc.dim('Run script without --session-restore to create a new session.'));
           process.exit(2);
         }
         // Protocol validation (existing code)
         // ... keep existing protocol validation block unchanged ...
         sessionStorageState = snapshotData.state;
         sessionId = options.sessionRestore;
         console.log(pc.green(`[Session] Restoring session from: ${snapshotData.url}`));
       } else if (parsedSessionPersistence?.enabled) {
         // Auto-restore from BSL session_persistence declaration
         const scriptBase = path.basename(scriptPath, path.extname(scriptPath))
           .replace(/[^a-zA-Z0-9_-]/g, '_').replace(/_+/g, '_');
         const snapshotId = parsedSessionPersistence.snapshot_id || scriptBase;

         const snapshotData = await loadSessionWithMeta(snapshotId);
         if (snapshotData) {
           // Protocol validation for auto-restore
           const firstNavigateStep = /* parse from script */ undefined;
           // Note: We cannot validate protocol without knowing target URL at this point
           // The runner will navigate first, protocol validation happens implicitly
           sessionStorageState = snapshotData.state;
           console.log(pc.green(`[Session] Auto-restoring session: ${snapshotId} (from: ${snapshotData.url})`));
         } else {
           console.log(pc.dim(`[Session] No existing session for: ${snapshotId} (will capture after successful run)`));
         }
         sessionId = snapshotId;
       } else {
         // Default: generate random session ID for implicit capture
         sessionId = generateSessionId();
       }
       ```

    4. Update the `sessionId` passed to BSLRunner options. When auto-restore is active (parsedSessionPersistence?.enabled && !options.sessionRestore), pass the snapshotId so capture overwrites the same file:
       ```typescript
       sessionId: options.sessionRestore ? undefined : sessionId,
       ```
       This line is already correct: manual restore suppresses capture, auto-restore allows capture (overwrite).

    5. Import `parseSteps` at the top of index.ts:
       ```typescript
       import { parseSteps } from '@browserlet/core/parser';
       ```
       Also import `path` if not already imported.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/cli/tsconfig.json` to verify types compile.
    Build CLI: `cd packages/cli && npm run build` succeeds.
    Run `node packages/cli/dist/index.js run --help` to verify CLI starts without errors.
  </verify>
  <done>
    CLI automatically restores sessions when BSL script has session_persistence.enabled=true and a matching snapshot exists. Auto-capture after successful run uses stable snapshot_id. Manual --session-restore flag still works and takes precedence. Scripts without session_persistence work unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/cli/tsconfig.json` — CLI types compile
2. `cd packages/cli && npm run build` — CLI builds successfully
3. Create a test BSL script with `session_persistence: {enabled: true, snapshot_id: "test"}`:
   - First run: session captured as "test.json" in sessions directory
   - Second run: session auto-restored from "test.json" before execution
4. Create a test BSL script WITHOUT session_persistence:
   - Runs normally with random session ID (existing behavior unchanged)
5. `npx vitest run` — full test suite passes
</verification>

<success_criteria>
- BSL scripts with session_persistence.enabled=true auto-capture session after successful CLI run
- BSL scripts with session_persistence.enabled=true auto-restore session before CLI run (when snapshot exists)
- snapshot_id produces stable session file names (not random)
- Manual --session-restore flag takes precedence over BSL declaration
- Scripts without session_persistence work exactly as before
- CLI builds and types compile
</success_criteria>

<output>
After completion, create `.planning/phases/035-bsl-integration-validation/035-02-SUMMARY.md`
</output>
