---
phase: 03-side-panel
plan: 07
type: execute
wave: 3
depends_on: ["03-03", "03-04", "03-05", "03-06"]
files_modified:
  - entrypoints/sidepanel/index.html
  - entrypoints/sidepanel/main.ts
  - entrypoints/sidepanel/components/RecordingView.ts
  - entrypoints/sidepanel/router.ts
autonomous: false

must_haves:
  truths:
    - "Side panel displays script list view by default"
    - "User can navigate between views (list, editor, recording, execution)"
    - "Recording mode has dedicated UI with action list"
    - "All components work together in integrated UI"
  artifacts:
    - path: "entrypoints/sidepanel/main.ts"
      provides: "Main app bootstrap with routing"
      contains: "van.add"
    - path: "entrypoints/sidepanel/router.ts"
      provides: "View routing state"
      exports: ["currentView", "navigateTo"]
    - path: "entrypoints/sidepanel/components/RecordingView.ts"
      provides: "Recording mode UI"
      exports: ["RecordingView"]
  key_links:
    - from: "entrypoints/sidepanel/main.ts"
      to: "entrypoints/sidepanel/router.ts"
      via: "reactive view switching"
      pattern: "currentView"
    - from: "entrypoints/sidepanel/router.ts"
      to: "all components"
      via: "conditional rendering"
      pattern: "navigateTo"
---

<objective>
Integrate all Phase 3 components into the side panel with navigation and routing.

Purpose: Wire together all UI components into a cohesive side panel experience with view-based navigation.
Output: Complete side panel with list, editor, recording, and execution views.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-side-panel/03-RESEARCH.md
@.planning/phases/03-side-panel/03-03-SUMMARY.md
@.planning/phases/03-side-panel/03-04-SUMMARY.md
@.planning/phases/03-side-panel/03-05-SUMMARY.md
@.planning/phases/03-side-panel/03-06-SUMMARY.md
@entrypoints/sidepanel/index.html
@entrypoints/sidepanel/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create router and RecordingView</name>
  <files>entrypoints/sidepanel/router.ts, entrypoints/sidepanel/components/RecordingView.ts</files>
  <action>
**Create entrypoints/sidepanel/router.ts:**

```typescript
import van from 'vanjs-core';
import type { Script } from '../../utils/types';

export type ViewName = 'list' | 'editor' | 'recording' | 'execution';

export const currentView = van.state<ViewName>('list');
export const editorScript = van.state<Script | null>(null);

export function navigateTo(view: ViewName, script?: Script): void {
  if (view === 'editor' && script) {
    editorScript.val = script;
  }
  currentView.val = view;
}

export function goBack(): void {
  currentView.val = 'list';
  editorScript.val = null;
}
```

**Create entrypoints/sidepanel/components/RecordingView.ts:**

Refactor existing recording UI into VanJS component:

```typescript
import van from 'vanjs-core';

const { div, button, span } = van.tags;

// Recording state (synced with storage)
export const isRecording = van.state(false);
export const recordedActions = van.state<Array<{
  type: string;
  timestamp: number;
  url: string;
  hints: Array<{ type: string; value: unknown }>;
  value?: string;
}>>([]);

// Load state from storage
async function loadRecordingState(): Promise<void> {
  try {
    const response = await chrome.runtime.sendMessage({ type: 'GET_STATE' });
    if (response.success && response.data) {
      isRecording.val = response.data.recordingState === 'recording';
      recordedActions.val = response.data.recordedActions || [];
    }
  } catch (error) {
    console.error('Failed to load recording state:', error);
  }
}

// Listen for state changes
chrome.storage.onChanged.addListener((changes, area) => {
  if (area === 'local' && changes.appState) {
    const state = changes.appState.newValue;
    isRecording.val = state?.recordingState === 'recording';
    recordedActions.val = state?.recordedActions || [];
  }
});

export async function toggleRecording(): Promise<void> {
  try {
    if (isRecording.val) {
      await chrome.runtime.sendMessage({ type: 'STOP_RECORDING' });
    } else {
      await chrome.runtime.sendMessage({
        type: 'SET_STATE',
        payload: { recordedActions: [] }
      });
      await chrome.runtime.sendMessage({ type: 'START_RECORDING' });
    }
  } catch (error) {
    console.error('Failed to toggle recording:', error);
  }
}

function ActionItem({ action }: { action: typeof recordedActions.val[0] }) {
  const hint = action.hints[0];
  const hintText = hint
    ? `${hint.type}: ${typeof hint.value === 'string' ? hint.value : JSON.stringify(hint.value)}`
    : '';
  const valueText = action.value
    ? ` = "${action.value.substring(0, 30)}${action.value.length > 30 ? '...' : ''}"`
    : '';

  return div({
    style: 'padding: 8px; border-bottom: 1px solid #f0f0f0;'
  },
    span({
      style: 'font-weight: 500; color: #333; text-transform: uppercase; font-size: 10px;'
    }, action.type),
    div({
      style: 'margin-top: 4px; font-size: 12px; color: #888; word-break: break-all;'
    }, hintText + valueText)
  );
}

export function RecordingView() {
  // Load initial state
  loadRecordingState();

  return div({ style: 'padding: 16px;' },
    // Recording status
    div({
      style: 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;'
    },
      span({ style: 'font-weight: 500;' },
        chrome.i18n.getMessage('recording') || 'Recording'
      ),
      span({
        style: () => `font-size: 12px; padding: 4px 8px; border-radius: 4px; ${
          isRecording.val
            ? 'background: #ffebee; color: #c62828;'
            : 'background: #e8f5e9; color: #2e7d32;'
        }`
      }, () => isRecording.val
        ? chrome.i18n.getMessage('recordingActive') || 'Recording...'
        : chrome.i18n.getMessage('idle') || 'Idle'
      )
    ),

    // Record button
    button({
      style: () => `width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; margin-bottom: 16px; ${
        isRecording.val
          ? 'background: #f44336; color: white;'
          : 'background: #4285f4; color: white;'
      }`,
      onclick: toggleRecording
    }, () => isRecording.val
      ? chrome.i18n.getMessage('stopRecording') || 'Stop Recording'
      : chrome.i18n.getMessage('startRecording') || 'Start Recording'
    ),

    // Actions section
    div({
      style: 'background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'
    },
      div({
        style: 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;'
      },
        span({ style: 'font-weight: 500; font-size: 14px;' },
          chrome.i18n.getMessage('capturedActions') || 'Captured Actions'
        ),
        span({
          style: 'font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 12px;'
        }, () => recordedActions.val.length.toString())
      ),
      div({ style: 'max-height: 300px; overflow-y: auto;' },
        () => {
          const actions = recordedActions.val;
          if (actions.length === 0) {
            return div({
              style: 'padding: 24px; text-align: center; color: #999; font-size: 13px;'
            }, chrome.i18n.getMessage('noActionsYet') || 'No actions recorded yet');
          }
          return div(
            ...actions.slice(-20).reverse().map(action => ActionItem({ action }))
          );
        }
      )
    )
  );
}
```
  </action>
  <verify>
1. Router state changes view correctly
2. RecordingView shows recording status and actions
3. Start/stop recording works
  </verify>
  <done>Router for view navigation and RecordingView component (UI-08).</done>
</task>

<task type="auto">
  <name>Task 2: Integrate all components in main.ts</name>
  <files>entrypoints/sidepanel/main.ts, entrypoints/sidepanel/index.html</files>
  <action>
**Replace entrypoints/sidepanel/main.ts with:**

```typescript
import van from 'vanjs-core';
import { currentView, navigateTo, goBack, editorScript } from './router';
import { loadScripts, selectedScript, selectScript } from './stores/scripts';
import { ScriptList } from './components/ScriptList';
import { ScriptEditor, disposeEditor } from './components/ScriptEditor';
import { RecordingView } from './components/RecordingView';
import { ExecutionView } from './components/ExecutionView';
import { ContextZone } from './components/ContextZone';
import { ImportButton, ExportButton } from './components/ImportExport';
import { saveScript } from '../../utils/storage/scripts';
import type { Script } from '../../utils/types';

const { div, button, span, nav } = van.tags;

// Navigation tabs
function NavTabs() {
  const tabs: Array<{ id: typeof currentView.val; label: string; icon: string }> = [
    { id: 'list', label: chrome.i18n.getMessage('scripts') || 'Scripts', icon: 'ðŸ“‹' },
    { id: 'recording', label: chrome.i18n.getMessage('record') || 'Record', icon: 'ðŸ”´' },
    { id: 'execution', label: chrome.i18n.getMessage('run') || 'Run', icon: 'â–¶ï¸' }
  ];

  return nav({
    style: 'display: flex; border-bottom: 1px solid #ddd; background: white;'
  },
    ...tabs.map(tab =>
      button({
        style: () => `flex: 1; padding: 12px 8px; border: none; background: none; cursor: pointer; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; ${
          currentView.val === tab.id || (currentView.val === 'editor' && tab.id === 'list')
            ? 'color: #4285f4; border-bottom: 2px solid #4285f4;'
            : 'color: #666;'
        }`,
        onclick: () => {
          if (currentView.val === 'editor') {
            disposeEditor();
          }
          navigateTo(tab.id);
        }
      },
        span({ style: 'font-size: 16px;' }, tab.icon),
        span(tab.label)
      )
    )
  );
}

// Create new script
async function createNewScript(): Promise<void> {
  const defaultContent = `name: New Script
version: "1.0.0"
description: ""
steps:
  - action: navigate
    url: "https://example.com"
`;

  const script = await saveScript({
    name: 'New Script',
    version: '1.0.0',
    content: defaultContent
  });

  await loadScripts();
  selectScript(script.id);
  navigateTo('editor', script);
}

// Main app component
function App() {
  return div({ style: 'display: flex; flex-direction: column; height: 100vh; background: #f5f5f5;' },
    // Header
    div({
      style: 'padding: 12px 16px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;'
    },
      span({ style: 'font-weight: 600; font-size: 16px;' }, 'Browserlet'),
      div({ style: 'display: flex; gap: 8px;' },
        ImportButton({ onImport: (script) => navigateTo('editor', script) })
      )
    ),

    // Context zone
    div({ style: 'padding: 12px 16px 0;' },
      ContextZone()
    ),

    // Navigation
    NavTabs(),

    // Content area
    div({ style: 'flex: 1; overflow: hidden; display: flex; flex-direction: column;' },
      () => {
        const view = currentView.val;

        if (view === 'list') {
          return ScriptList({
            onScriptSelect: (script) => navigateTo('editor', script),
            onNewScript: createNewScript
          });
        }

        if (view === 'editor') {
          const script = editorScript.val;
          if (!script) {
            navigateTo('list');
            return div();
          }
          return div({ style: 'display: flex; flex-direction: column; height: 100%;' },
            // Editor toolbar
            div({
              style: 'display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-bottom: 1px solid #ddd;'
            },
              button({
                style: 'background: none; border: none; cursor: pointer; font-size: 14px; color: #666;',
                onclick: () => {
                  disposeEditor();
                  goBack();
                }
              }, 'â† ' + (chrome.i18n.getMessage('back') || 'Back')),
              div({ style: 'display: flex; gap: 8px;' },
                ExportButton({ script })
              )
            ),
            // Editor
            div({ style: 'flex: 1;' },
              ScriptEditor({
                script,
                onSave: (updated) => {
                  // Script already saved by auto-save
                }
              })
            )
          );
        }

        if (view === 'recording') {
          return RecordingView();
        }

        if (view === 'execution') {
          return ExecutionView();
        }

        return div();
      }
    )
  );
}

// Initialize
async function init() {
  // Check service worker
  try {
    await chrome.runtime.sendMessage({ type: 'PING' });
  } catch (error) {
    console.error('Service worker not available:', error);
  }

  // Load scripts
  await loadScripts();

  // Mount app
  const root = document.getElementById('app');
  if (root) {
    van.add(root, App());
  }
}

init();
```

**Update entrypoints/sidepanel/index.html:**

Replace entire file with:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browserlet</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    #app {
      height: 100vh;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: #4285f4;
      color: white;
    }

    .btn-primary:hover {
      background: #3367d6;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Monaco editor container needs explicit height */
    #monaco-editor-container {
      min-height: 300px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="./main.ts" type="module"></script>
</body>
</html>
```
  </action>
  <verify>
1. npm run dev starts without errors
2. Side panel shows navigation tabs
3. Scripts tab shows list with search
4. Clicking script opens editor
5. Record tab shows recording controls
6. Run tab shows execution view
  </verify>
  <done>Full side panel integration with navigation, all views connected.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 3 Side Panel with all features integrated</what-built>
  <how-to-verify>
1. Run `npm run dev` and load extension in Chrome
2. Open side panel (click extension icon)
3. **Scripts tab:**
   - Click "+" to create new script
   - Edit script in Monaco with YAML highlighting
   - Search filters scripts
   - Export button downloads YAML
   - Import button accepts YAML file
4. **Record tab:**
   - Start/stop recording works
   - Actions appear in list
5. **Run tab:**
   - Progress bar visible (will show placeholder until Phase 4)
   - Copy JSON/CSV buttons work with mock data
6. **Context zone:**
   - Shows current tab URL
   - Updates when switching tabs
7. **i18n:**
   - Switch browser language to French
   - UI labels should be in French
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Extension builds without errors
2. Side panel opens with all views accessible
3. Monaco editor works with YAML
4. Recording controls functional
5. Import/export works
6. i18n displays correctly
</verification>

<success_criteria>
All Phase 3 success criteria met:
- User can see list of saved scripts with search and filtering (UI-01, UI-02)
- User can edit BSL scripts in Monaco Editor with YAML syntax highlighting (UI-03)
- User can import and export scripts as YAML files (STOR-02, STOR-03)
- Execution progress displays current step with progress bar (UI-04)
- Execution results can be copied as JSON or CSV (UI-05, UI-06)
- UI appears in French or English based on browser language (I18N-01, I18N-02, I18N-03)
- Scripts are persisted locally and survive browser restart (STOR-01)
- Recording mode has dedicated UI with action list (UI-08)
- Context zone shows current page URL (UI-07)
</success_criteria>

<output>
After completion, create `.planning/phases/03-side-panel/03-07-SUMMARY.md`
</output>
