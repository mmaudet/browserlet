---
phase: 03-side-panel
plan: 06
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - entrypoints/sidepanel/components/ExecutionView.ts
  - entrypoints/sidepanel/components/ContextZone.ts
  - entrypoints/sidepanel/stores/execution.ts
autonomous: true

must_haves:
  truths:
    - "Execution progress displays current step with progress bar"
    - "Execution results can be viewed"
    - "Results can be copied as JSON or CSV"
    - "Context zone shows current page URL"
  artifacts:
    - path: "entrypoints/sidepanel/components/ExecutionView.ts"
      provides: "Progress bar and results display"
      exports: ["ExecutionView"]
    - path: "entrypoints/sidepanel/components/ContextZone.ts"
      provides: "Current page context display"
      exports: ["ContextZone"]
    - path: "entrypoints/sidepanel/stores/execution.ts"
      provides: "Execution state management"
      exports: ["executionState", "startExecution", "updateProgress"]
  key_links:
    - from: "entrypoints/sidepanel/components/ExecutionView.ts"
      to: "@json2csv/plainjs"
      via: "Parser"
      pattern: "new Parser"
---

<objective>
Create execution progress view with results display and context zone showing current page info.

Purpose: Provide visual feedback during script execution and enable copying results for further use.
Output: ExecutionView with progress bar and copy buttons, ContextZone showing page URL.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-side-panel/03-RESEARCH.md
@.planning/phases/03-side-panel/03-02-SUMMARY.md
@utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create execution state store</name>
  <files>entrypoints/sidepanel/stores/execution.ts</files>
  <action>
Create entrypoints/sidepanel/stores/execution.ts:

```typescript
import van from 'vanjs-core';
import type { Script, ExecutionRecord } from '../../../utils/types';
import { addExecutionRecord, updateExecutionRecord } from '../../../utils/storage/history';

// Execution state
export const isExecuting = van.state(false);
export const currentScript = van.state<Script | null>(null);
export const currentStep = van.state(0);
export const totalSteps = van.state(0);
export const executionStatus = van.state<'idle' | 'running' | 'completed' | 'failed' | 'stopped'>('idle');
export const executionResults = van.state<unknown[]>([]);
export const executionError = van.state<string | null>(null);
export const currentRecordId = van.state<string | null>(null);

// Progress percentage derived
export const progressPercent = van.derive(() => {
  if (totalSteps.val === 0) return 0;
  return Math.round((currentStep.val / totalSteps.val) * 100);
});

// Start execution (placeholder - actual execution in Phase 4)
export async function startExecution(script: Script): Promise<void> {
  isExecuting.val = true;
  currentScript.val = script;
  currentStep.val = 0;
  executionStatus.val = 'running';
  executionResults.val = [];
  executionError.val = null;

  // Parse steps from script content to get total
  // For now, use placeholder count
  totalSteps.val = 10; // Will be parsed from script.content in Phase 4

  // Create execution record
  const record = await addExecutionRecord({
    scriptId: script.id,
    scriptName: script.name,
    startedAt: Date.now(),
    status: 'running',
    currentStep: 0,
    totalSteps: totalSteps.val
  });
  currentRecordId.val = record.id;
}

// Update progress (called by execution engine in Phase 4)
export async function updateProgress(step: number, result?: unknown): Promise<void> {
  currentStep.val = step;

  if (result !== undefined) {
    executionResults.val = [...executionResults.val, result];
  }

  // Update record
  if (currentRecordId.val && currentScript.val) {
    await updateExecutionRecord(currentScript.val.id, currentRecordId.val, {
      currentStep: step,
      status: 'running'
    });
  }
}

// Complete execution
export async function completeExecution(results?: unknown): Promise<void> {
  isExecuting.val = false;
  executionStatus.val = 'completed';
  currentStep.val = totalSteps.val;

  if (results !== undefined) {
    executionResults.val = Array.isArray(results) ? results : [results];
  }

  if (currentRecordId.val && currentScript.val) {
    await updateExecutionRecord(currentScript.val.id, currentRecordId.val, {
      status: 'completed',
      completedAt: Date.now(),
      results: executionResults.val
    });
  }
}

// Fail execution
export async function failExecution(error: string): Promise<void> {
  isExecuting.val = false;
  executionStatus.val = 'failed';
  executionError.val = error;

  if (currentRecordId.val && currentScript.val) {
    await updateExecutionRecord(currentScript.val.id, currentRecordId.val, {
      status: 'failed',
      completedAt: Date.now(),
      error
    });
  }
}

// Stop execution (user requested)
export async function stopExecution(): Promise<void> {
  isExecuting.val = false;
  executionStatus.val = 'stopped';

  if (currentRecordId.val && currentScript.val) {
    await updateExecutionRecord(currentScript.val.id, currentRecordId.val, {
      status: 'stopped',
      completedAt: Date.now()
    });
  }
}

// Reset to idle
export function resetExecution(): void {
  isExecuting.val = false;
  currentScript.val = null;
  currentStep.val = 0;
  totalSteps.val = 0;
  executionStatus.val = 'idle';
  executionResults.val = [];
  executionError.val = null;
  currentRecordId.val = null;
}
```
  </action>
  <verify>Run TypeScript check - no errors.</verify>
  <done>Execution state store with progress tracking and history recording.</done>
</task>

<task type="auto">
  <name>Task 2: Create ExecutionView component</name>
  <files>entrypoints/sidepanel/components/ExecutionView.ts</files>
  <action>
Create entrypoints/sidepanel/components/ExecutionView.ts:

```typescript
import van from 'vanjs-core';
import { Parser } from '@json2csv/plainjs';
import {
  isExecuting, currentScript, currentStep, totalSteps,
  progressPercent, executionStatus, executionResults, executionError,
  stopExecution, resetExecution
} from '../stores/execution';

const { div, button, span, pre } = van.tags;

export function ExecutionView() {
  const copySuccess = van.state<string | null>(null);

  const showCopySuccess = (message: string) => {
    copySuccess.val = message;
    setTimeout(() => { copySuccess.val = null; }, 2000);
  };

  const copyAsJSON = async () => {
    try {
      const json = JSON.stringify(executionResults.val, null, 2);
      await navigator.clipboard.writeText(json);
      showCopySuccess(chrome.i18n.getMessage('copiedJson') || 'Copied as JSON');
    } catch (error) {
      console.error('Copy failed:', error);
    }
  };

  const copyAsCSV = async () => {
    try {
      const results = executionResults.val;
      if (results.length === 0) {
        showCopySuccess(chrome.i18n.getMessage('noResults') || 'No results to copy');
        return;
      }

      // Convert to array of objects if needed
      const data = results.map((r, i) =>
        typeof r === 'object' && r !== null
          ? r as Record<string, unknown>
          : { index: i, value: r }
      );

      const parser = new Parser();
      const csv = parser.parse(data as Record<string, unknown>[]);
      await navigator.clipboard.writeText(csv);
      showCopySuccess(chrome.i18n.getMessage('copiedCsv') || 'Copied as CSV');
    } catch (error) {
      console.error('CSV conversion failed:', error);
    }
  };

  return div({ class: 'execution-view', style: 'padding: 16px;' },
    // Header
    div({ style: 'margin-bottom: 16px;' },
      () => currentScript.val
        ? div(
            span({ style: 'font-weight: 500; color: #333;' }, currentScript.val.name),
            span({ style: 'margin-left: 8px; font-size: 12px; color: #666;' },
              () => `${chrome.i18n.getMessage('step') || 'Step'} ${currentStep.val} / ${totalSteps.val}`
            )
          )
        : span({ style: 'color: #999;' }, chrome.i18n.getMessage('noExecution') || 'No execution in progress')
    ),

    // Progress bar
    () => isExecuting.val || executionStatus.val !== 'idle' ? div({
      style: 'margin-bottom: 16px;'
    },
      div({
        style: 'height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;'
      },
        div({
          style: () => `height: 100%; background: ${executionStatus.val === 'failed' ? '#f44336' : '#4caf50'}; width: ${progressPercent.val}%; transition: width 0.3s;`
        })
      ),
      div({ style: 'display: flex; justify-content: space-between; margin-top: 4px; font-size: 12px; color: #666;' },
        span(() => {
          const status = executionStatus.val;
          if (status === 'running') return chrome.i18n.getMessage('running') || 'Running...';
          if (status === 'completed') return chrome.i18n.getMessage('completed') || 'Completed';
          if (status === 'failed') return chrome.i18n.getMessage('failed') || 'Failed';
          if (status === 'stopped') return chrome.i18n.getMessage('stopped') || 'Stopped';
          return '';
        }),
        span(() => `${progressPercent.val}%`)
      )
    ) : null,

    // Error display
    () => executionError.val ? div({
      style: 'padding: 12px; background: #ffebee; border-radius: 6px; color: #c62828; font-size: 13px; margin-bottom: 16px;'
    }, executionError.val) : null,

    // Controls
    () => isExecuting.val ? div({ style: 'margin-bottom: 16px;' },
      button({
        class: 'btn btn-danger',
        style: 'width: 100%; padding: 10px;',
        onclick: stopExecution
      }, chrome.i18n.getMessage('stopExecution') || 'Stop Execution')
    ) : executionStatus.val !== 'idle' ? div({ style: 'margin-bottom: 16px;' },
      button({
        class: 'btn btn-secondary',
        style: 'width: 100%; padding: 10px;',
        onclick: resetExecution
      }, chrome.i18n.getMessage('clearResults') || 'Clear Results')
    ) : null,

    // Results section
    () => executionResults.val.length > 0 ? div(
      div({ style: 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;' },
        span({ style: 'font-weight: 500; color: #333;' },
          chrome.i18n.getMessage('results') || 'Results'
        ),
        div({ style: 'display: flex; gap: 8px;' },
          button({
            class: 'btn btn-secondary',
            style: 'padding: 4px 12px; font-size: 12px;',
            onclick: copyAsJSON
          }, 'JSON'),
          button({
            class: 'btn btn-secondary',
            style: 'padding: 4px 12px; font-size: 12px;',
            onclick: copyAsCSV
          }, 'CSV')
        )
      ),
      () => copySuccess.val ? div({
        style: 'background: #e8f5e9; color: #2e7d32; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 8px;'
      }, copySuccess.val) : null,
      pre({
        style: 'background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; max-height: 200px;'
      }, () => JSON.stringify(executionResults.val, null, 2))
    ) : null
  );
}
```
  </action>
  <verify>
1. Render ExecutionView
2. Progress bar shows percentage
3. Copy JSON/CSV buttons work (test with mock data)
  </verify>
  <done>ExecutionView with progress bar, step counter, and copy buttons (UI-04, UI-05, UI-06).</done>
</task>

<task type="auto">
  <name>Task 3: Create ContextZone component</name>
  <files>entrypoints/sidepanel/components/ContextZone.ts</files>
  <action>
Create entrypoints/sidepanel/components/ContextZone.ts:

```typescript
import van from 'vanjs-core';

const { div, span, a } = van.tags;

// Context state
export const currentUrl = van.state('');
export const currentTitle = van.state('');

// Update context from active tab
export async function updateContext(): Promise<void> {
  try {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    if (tab) {
      currentUrl.val = tab.url || '';
      currentTitle.val = tab.title || '';
    }
  } catch (error) {
    console.error('Failed to get tab info:', error);
  }
}

// Listen for tab changes
chrome.tabs.onActivated.addListener(() => {
  updateContext();
});

chrome.tabs.onUpdated.addListener((tabId, changeInfo) => {
  if (changeInfo.url || changeInfo.title) {
    updateContext();
  }
});

export function ContextZone() {
  // Load initial context
  updateContext();

  return div({
    class: 'context-zone',
    style: 'padding: 12px; background: #f5f5f5; border-radius: 8px; margin-bottom: 16px;'
  },
    div({ style: 'font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;' },
      chrome.i18n.getMessage('currentPage') || 'Current Page'
    ),
    () => currentUrl.val ? div(
      div({
        style: 'font-weight: 500; color: #333; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'
      }, currentTitle.val || chrome.i18n.getMessage('untitled') || 'Untitled'),
      div({
        style: 'font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px;'
      }, () => {
        try {
          const url = new URL(currentUrl.val);
          return url.hostname + url.pathname;
        } catch {
          return currentUrl.val;
        }
      })
    ) : div({
      style: 'font-size: 13px; color: #999;'
    }, chrome.i18n.getMessage('noPage') || 'No page detected')
  );
}
```

Note: Detected entities placeholder is for Phase 6 (Contextual Triggers). For now, just show URL and title.
  </action>
  <verify>
1. Render ContextZone
2. Shows current tab URL and title
3. Updates when switching tabs
  </verify>
  <done>ContextZone displays current page URL and title (UI-07).</done>
</task>

</tasks>

<verification>
1. ExecutionView shows progress bar with percentage
2. Step counter updates correctly
3. Copy JSON/CSV copies to clipboard
4. ContextZone shows current tab info
5. Tab switching updates context
</verification>

<success_criteria>
- Execution progress shows current step with progress bar (UI-04)
- Execution results display extracted data (UI-05)
- Results can be copied as JSON or CSV (UI-06)
- Context zone shows current page URL (UI-07)
</success_criteria>

<output>
After completion, create `.planning/phases/03-side-panel/03-06-SUMMARY.md`
</output>
