---
phase: 04-playback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - entrypoints/content/playback/types.ts
  - utils/yaml/stepParser.ts
autonomous: true

must_haves:
  truths:
    - "BSL YAML scripts can be parsed into typed step objects"
    - "Each step has action, target (with hints), optional value/output"
    - "Timeout strings (10s, 5000ms) are parsed to milliseconds"
  artifacts:
    - path: "entrypoints/content/playback/types.ts"
      provides: "BSLStep, ParsedScript, PlaybackState, ExecutionResult types"
      exports: ["BSLStep", "ParsedScript", "PlaybackState", "ExecutionResult", "ActionType"]
    - path: "utils/yaml/stepParser.ts"
      provides: "Step parsing and timeout conversion"
      exports: ["parseSteps", "parseTimeout"]
  key_links:
    - from: "utils/yaml/stepParser.ts"
      to: "js-yaml"
      via: "yaml.load import"
      pattern: "import.*yaml.*from.*js-yaml"
    - from: "utils/yaml/stepParser.ts"
      to: "entrypoints/content/playback/types.ts"
      via: "BSLStep type import"
      pattern: "import.*BSLStep.*from"
---

<objective>
Create playback type definitions and BSL step parser for script execution.

Purpose: Establish the typed foundation that all playback modules depend on. Without proper types and parsing, the execution engine cannot understand BSL scripts.

Output:
- `entrypoints/content/playback/types.ts` - All playback-specific TypeScript types
- `utils/yaml/stepParser.ts` - BSL step extraction and timeout parsing
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-playback/04-RESEARCH.md

# Existing types to extend/reference
@entrypoints/content/recording/types.ts
@utils/yaml/parser.ts
@utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create playback types</name>
  <files>entrypoints/content/playback/types.ts</files>
  <action>
Create `entrypoints/content/playback/types.ts` with:

1. **ActionType** (8 BSL actions):
   ```typescript
   export type ActionType = 'click' | 'type' | 'select' | 'extract' | 'wait_for' | 'navigate' | 'scroll' | 'hover';
   ```

2. **BSLStep** interface:
   ```typescript
   export interface BSLStep {
     id?: string;
     action: ActionType;
     target?: {
       intent?: string;
       hints: SemanticHint[];
       fallback_selector?: string;
     };
     value?: string;
     output?: {
       variable: string;
       transform?: string;
     };
     timeout?: string; // e.g., "10s", "30s", "5000ms"
   }
   ```

3. **ParsedScript** interface:
   ```typescript
   export interface ParsedScript {
     name: string;
     steps: BSLStep[];
     metadata?: Record<string, unknown>;
     session_check?: SessionCheckConfig;
   }
   ```

4. **SessionCheckConfig** (for AUTH requirements):
   ```typescript
   export interface SessionCheckConfig {
     indicator?: { hints: SemanticHint[] };
     absence_indicator?: { hints: SemanticHint[] };
     url_patterns?: string[];
   }
   ```

5. **PlaybackState**:
   ```typescript
   export type PlaybackState = 'idle' | 'running' | 'paused' | 'waiting_auth' | 'stopped';
   ```

6. **ExecutionResult**:
   ```typescript
   export interface ExecutionResult {
     status: 'completed' | 'failed' | 'stopped';
     step?: number;
     error?: string;
     results?: Record<string, unknown>;
   }
   ```

7. **ResolverResult** (for semantic resolver):
   ```typescript
   export interface ResolverResult {
     element: Element | null;
     confidence: number;
     matchedHints: string[];
     failedHints: string[];
   }
   ```

Import SemanticHint from recording/types.ts. Re-export it for convenience.
  </action>
  <verify>
Run `npx tsc --noEmit entrypoints/content/playback/types.ts` - no TypeScript errors.
File exists with all 7 type definitions.
  </verify>
  <done>
All playback types defined: ActionType (8 values), BSLStep, ParsedScript, SessionCheckConfig, PlaybackState, ExecutionResult, ResolverResult. SemanticHint re-exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BSL step parser</name>
  <files>utils/yaml/stepParser.ts</files>
  <action>
Create `utils/yaml/stepParser.ts` with:

1. **parseSteps(yamlContent: string): ParsedScript**
   - Use js-yaml to parse YAML content
   - Validate required fields: name (string), steps (array)
   - Map each step to BSLStep type
   - Extract optional session_check config
   - Throw descriptive error if invalid

2. **parseTimeout(timeout: string | undefined): number**
   - Default: 10000ms (10 seconds)
   - Parse formats: "10s" -> 10000, "5000ms" -> 5000, "30" -> 30000 (assume seconds)
   - Use regex: `/^(\d+)(s|ms)?$/`
   - Return milliseconds

3. **validateStep(step: unknown, index: number): BSLStep**
   - Validate step has valid action (one of 8 types)
   - Validate target exists for actions that need it (click, type, select, extract, wait_for, scroll, hover)
   - navigate action needs value (URL), not target
   - Return typed BSLStep or throw with step index in error

Example usage:
```typescript
import { parseSteps, parseTimeout } from '../utils/yaml/stepParser';
const script = parseSteps(yamlContent);
const timeoutMs = parseTimeout(script.steps[0].timeout);
```
  </action>
  <verify>
Run `npx tsc --noEmit utils/yaml/stepParser.ts` - no TypeScript errors.
File exports parseSteps and parseTimeout functions.
  </verify>
  <done>
Step parser converts BSL YAML to typed ParsedScript. Timeout parser handles "10s", "5000ms", numeric formats. Validation provides clear error messages with step index.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for step parser</name>
  <files>utils/yaml/stepParser.test.ts</files>
  <action>
Create `utils/yaml/stepParser.test.ts` with tests:

1. **parseSteps tests:**
   - Valid script with multiple steps returns ParsedScript
   - Missing name throws error
   - Missing steps throws error
   - Invalid action type throws error
   - navigate step without value throws error
   - click step without target throws error
   - Extracts session_check config when present

2. **parseTimeout tests:**
   - "10s" returns 10000
   - "5000ms" returns 5000
   - "30" returns 30000 (assumes seconds)
   - undefined returns 10000 (default)
   - Invalid format returns 10000 (default)

Use vitest. Follow existing test patterns from the codebase.
  </action>
  <verify>
Run `npm test -- utils/yaml/stepParser.test.ts` - all tests pass.
  </verify>
  <done>
Unit tests cover happy path and error cases for step parsing and timeout conversion. Tests validate error messages include step index.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes for new files
2. Unit tests: `npm test -- utils/yaml/stepParser.test.ts` passes
3. Types are importable: Create temp file importing from playback/types.ts, compiles without error
</verification>

<success_criteria>
- [ ] playback/types.ts exists with 7+ type definitions
- [ ] stepParser.ts exports parseSteps and parseTimeout
- [ ] parseSteps converts valid YAML to ParsedScript
- [ ] parseTimeout handles "10s", "5000ms", undefined formats
- [ ] Unit tests pass for parser edge cases
- [ ] No TypeScript errors in new files
</success_criteria>

<output>
After completion, create `.planning/phases/04-playback/04-01-SUMMARY.md`
</output>
