---
phase: 04-playback
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - entrypoints/content/playback/humanizer.ts
autonomous: true

must_haves:
  truths:
    - "Delays between actions vary randomly within configured ranges"
    - "Typing delay is character-by-character with variable timing"
    - "Delays use Gaussian distribution for natural feel"
  artifacts:
    - path: "entrypoints/content/playback/humanizer.ts"
      provides: "Humanization delay utilities"
      exports: ["humanizedWait", "randomDelay", "HumanizerConfig", "DEFAULT_CONFIG"]
  key_links:
    - from: "entrypoints/content/playback/humanizer.ts"
      to: "Math functions"
      via: "Gaussian random implementation"
      pattern: "Math\\.sqrt.*Math\\.log.*Math\\.cos"
---

<objective>
Create humanization layer for realistic delays between automation actions.

Purpose: Avoid bot detection by adding human-like timing variations. Legacy ERPs may have basic bot detection; realistic delays make automation less detectable and more reliable.

Output:
- `entrypoints/content/playback/humanizer.ts` - Delay utilities with Gaussian distribution
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-playback/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create humanizer module</name>
  <files>entrypoints/content/playback/humanizer.ts</files>
  <action>
Create `entrypoints/content/playback/humanizer.ts` with:

1. **HumanizerConfig interface:**
   ```typescript
   export interface HumanizerConfig {
     baseDelay: { min: number; max: number };   // ms between actions (500-2000)
     typeDelay: { min: number; max: number };   // ms between keystrokes (50-150)
     scrollDelay: { min: number; max: number }; // ms for scroll settle (100-300)
   }
   ```

2. **DEFAULT_CONFIG constant:**
   ```typescript
   export const DEFAULT_CONFIG: HumanizerConfig = {
     baseDelay: { min: 500, max: 2000 },
     typeDelay: { min: 50, max: 150 },
     scrollDelay: { min: 100, max: 300 }
   };
   ```

3. **randomDelay(min: number, max: number): number**
   - Use Box-Muller transform for Gaussian distribution
   - Formula: `Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v)`
   - Normalize to 0-1 range: `(gaussian + 3) / 6`
   - Map to min-max range
   - Clamp result to stay within bounds

4. **humanizedWait(config?: Partial<HumanizerConfig>): Promise<void>**
   - Merge provided config with DEFAULT_CONFIG
   - Generate delay using randomDelay for baseDelay range
   - Return Promise that resolves after delay
   - Use setTimeout wrapped in Promise

5. **typeCharacterDelay(config?: Partial<HumanizerConfig>): Promise<void>**
   - Same pattern but uses typeDelay range
   - Shorter delays for natural typing feel

6. **scrollSettleDelay(config?: Partial<HumanizerConfig>): Promise<void>**
   - Uses scrollDelay range
   - For waiting after scroll animations
  </action>
  <verify>
Run `npx tsc --noEmit entrypoints/content/playback/humanizer.ts` - no errors.
Manually verify randomDelay produces values in expected range by logging a few samples.
  </verify>
  <done>
Humanizer provides Gaussian-distributed random delays. DEFAULT_CONFIG sets reasonable ranges (500-2000ms base, 50-150ms typing). Three delay functions cover different use cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add humanizer unit tests</name>
  <files>entrypoints/content/playback/humanizer.test.ts</files>
  <action>
Create `entrypoints/content/playback/humanizer.test.ts` with:

1. **randomDelay tests:**
   - Returns value within min-max range (run 100 iterations)
   - Different calls return different values (not constant)
   - Handles edge case where min === max

2. **humanizedWait tests:**
   - Resolves after delay (mock setTimeout or use short range for speed)
   - Uses DEFAULT_CONFIG when no config provided
   - Merges partial config with defaults

3. **typeCharacterDelay tests:**
   - Uses typeDelay range from config
   - Resolves after delay

4. **DEFAULT_CONFIG tests:**
   - Verify default values are as documented
   - baseDelay: 500-2000, typeDelay: 50-150, scrollDelay: 100-300

Use vitest with vi.useFakeTimers() for timer-based tests to avoid slow tests.
  </action>
  <verify>
Run `npm test -- entrypoints/content/playback/humanizer.test.ts` - all tests pass.
  </verify>
  <done>
Unit tests verify randomDelay stays in bounds, delays resolve correctly, and DEFAULT_CONFIG has expected values. Tests use fake timers for speed.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit entrypoints/content/playback/humanizer.ts`
2. Unit tests pass: `npm test -- entrypoints/content/playback/humanizer.test.ts`
3. randomDelay distribution check: Call 1000 times, verify mean is roughly centered
</verification>

<success_criteria>
- [ ] humanizer.ts exports HumanizerConfig, DEFAULT_CONFIG, randomDelay, humanizedWait, typeCharacterDelay, scrollSettleDelay
- [ ] randomDelay uses Gaussian distribution (Box-Muller)
- [ ] DEFAULT_CONFIG has documented ranges
- [ ] Unit tests pass with fake timers
- [ ] No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-playback/04-02-SUMMARY.md`
</output>
